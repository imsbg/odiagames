<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Math Wizard | ଗଣିତ ବିଜ୍ଞ</title>
    <meta name="theme-color" content="#007AFF"/>
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png">
    <link rel="manifest" href="manifest.json">
    <meta id="meta-description" name="description" content="A fun math game for kids. Learn addition, subtraction, multiplication, and division with SB Math Wizard. An offline-first math game.">
    <meta name="keywords" content="Odia math game, ganita bigyan, math for kids, odia learning, ଗଣିତ ଖେଳ, ପିଲାଙ୍କ ପାଇଁ ଗଣିତ, SB Ganita Bigyan, offline math game, PWA game">
    <link rel="apple-touch-icon" href="/icons/icon-512x512.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Oriya:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            /* iOS Light Theme */
            --ios-blue-light: #007AFF; --ios-green-light: #34C759; --ios-red-light: #FF3B30; --ios-orange-light: #FF9500; --ios-yellow-light: #FFCC00;
            --ios-bg-light: #F2F2F7; --ios-card-bg-light: rgba(255, 255, 255, 0.8); --ios-text-light: #000000;
            --ios-text-secondary-light: #8E8E93; --ios-border-light: #E5E5EA;

            /* iOS Dark Theme */
            --ios-blue-dark: #0A84FF; --ios-green-dark: #30D158; --ios-red-dark: #FF453A; --ios-orange-dark: #FF9F0A; --ios-yellow-dark: #FFD60A;
            --ios-bg-dark: #000000; --ios-card-bg-dark: rgba(29, 29, 31, 0.8); --ios-text-dark: #FFFFFF;
            --ios-text-secondary-dark: #8D8D92; --ios-border-dark: #38383A;
            
            --header-height-mobile: 60px;
            --header-height-tablet: 100px;
        }
        [data-theme="light"] {
            --primary-color: var(--ios-blue-light); --green: var(--ios-green-light); --red: var(--ios-red-light); --orange: var(--ios-orange-light); --yellow: var(--ios-yellow-light);
            --bg-color: var(--ios-bg-light); --card-bg: var(--ios-card-bg-light); --text-color: var(--ios-text-light);
            --text-secondary-color: var(--ios-text-secondary-light); --border-color: var(--ios-border-light);
            --select-bg: #E9E9EB;
        }
        [data-theme="dark"] {
            --primary-color: var(--ios-blue-dark); --green: var(--ios-green-dark); --red: var(--ios-red-dark); --orange: var(--ios-orange-dark); --yellow: var(--ios-yellow-dark);
            --bg-color: var(--ios-bg-dark); --card-bg: var(--ios-card-bg-dark); --text-color: var(--ios-text-dark);
            --text-secondary-color: var(--ios-text-secondary-dark); --border-color: var(--ios-border-dark);
            --select-bg: #2C2C2E;
        }

        /* --- ANIMATIONS --- */
        @keyframes question-swoop-in { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .question-animate-in { animation: question-swoop-in 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes options-swoop-in { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .options-animate-in { animation: options-swoop-in 0.5s cubic-bezier(0.25, 1, 0.5, 1) 0.1s forwards; opacity: 0; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); } }
        .shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes pop-correct { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .pop-correct { animation: pop-correct 0.4s ease-in-out; }

        /* --- GLOBAL STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Poppins', 'Noto Sans Oriya', sans-serif; 
            background-color: var(--bg-color); color: var(--text-color); 
            transition: background-color 0.3s, color 0.3s; 
            overscroll-behavior-y: contain;
            padding-top: var(--header-height-mobile);
        }
        .container { max-width: 900px; margin: 0 auto; padding: 0 1rem; }
        
        /* --- HEADER --- */
        .app-header {
            background-color: var(--card-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 0 1rem; min-height: var(--header-height-mobile);
            border-bottom: 1px solid var(--border-color);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
        }
        .header-content { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; width: 100%; min-height: var(--header-height-mobile); gap: 0.5rem 1rem; padding: 0.5rem 0; }
        .title-group { display: flex; align-items: center; gap: 0.75rem; }
        .logo { font-size: 1.8rem; color: var(--primary-color); }
        .title { font-size: 1.5rem; font-weight: 700; color: var(--text-color); }
        .scores-group { display: flex; gap: 1rem; text-align: right; flex-wrap: wrap; }
        .score-container { font-size: 1rem; font-weight: 600; white-space: nowrap; color: var(--text-secondary-color); }
        .score-value { color: var(--text-color); font-weight: 700; }
        
        /* --- MAIN CONTENT & CARDS --- */
        main { padding: 2rem 0; }
        .game-card, .controls-panel {
            background-color: var(--card-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color); border-radius: 24px;
            padding: 1.5rem; text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative; overflow: hidden; transition: all 0.3s ease;
        }
        .controls-panel { margin-bottom: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .controls-panel .title-group, .controls-panel .scores-group { display: none; }
        
        /* --- CONTROLS --- */
        .top-controls { display: flex; flex-direction: column; gap: 1.5rem; }
        .control-group { display: flex; align-items: center; justify-content: space-around; width: 100%; padding: 0.5rem 0; }
        .control-btn { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; font-size: 1.5rem; transition: color 0.2s, transform 0.2s ease; text-decoration: none; }
        .control-btn:hover { color: var(--primary-color); }
        .control-btn:active { transform: scale(0.9); }
        
        .select-group { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; }
        .select-group label { color: var(--text-secondary-color); font-weight: 600; font-size: 0.9rem; text-align: left; }
        .select-group select {
            appearance: none; -webkit-appearance: none; background-color: var(--select-bg);
            color: var(--text-color); border: none; border-radius: 10px; padding: 0.75rem 1rem;
            font-family: inherit; font-weight: 600; cursor: pointer; width: 100%;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
        }
        #timed-challenge-btn { background: var(--primary-color); color: white; border: none; border-radius: 10px; padding: 0.75rem 1rem; font-weight: 600; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: filter 0.2s; }
        #timed-challenge-btn:hover { filter: brightness(1.1); }

        /* --- GAME AREA --- */
        #game-area.hidden { display: none; }
        #timer-display { font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; display: none; }
        #instruction { color: var(--text-secondary-color); font-size: 1.1rem; margin-bottom: 1rem; font-weight: 600; }
        #question { font-size: clamp(2.8rem, 10vw, 4rem); font-weight: 700; margin-bottom: 2rem; word-wrap: break-word; line-height: 1.2; }
        .options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; }
        .option-btn {
            background-color: var(--select-bg); color: var(--text-color); border: 2px solid transparent; border-radius: 16px;
            padding: 1.25rem; font-size: clamp(1.5rem, 6vw, 2rem); font-weight: 700; cursor: pointer;
            transition: all 0.2s ease; font-family: 'Poppins', 'Noto Sans Oriya', sans-serif;
            min-height: 80px; display: grid; place-items: center;
        }
        .option-btn:hover:not(.disabled) { transform: translateY(-4px); filter: brightness(0.95); }
        .option-btn:active:not(.disabled) { transform: translateY(-2px) scale(0.98); }
        .option-btn.disabled { cursor: not-allowed; opacity: 0.7; }
        .option-btn.selected.correct, .option-btn.correct-answer { background-color: var(--green); color: white; border-color: transparent; }
        .option-btn.selected.wrong { background-color: var(--red); color: white; border-color: transparent; }
        
        .action-buttons { display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap; min-height: 50px; }
        .action-btn {
            color: white; border: none; border-radius: 999px; padding: 0.8rem 2rem; font-size: 1.2rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease; font-family: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;
        }
        .action-btn:active { transform: scale(0.95); }
        #next-question-btn { background: linear-gradient(45deg, var(--ios-blue-light), #4499ff); display: none; }
        #skip-question-btn { background-color: var(--text-secondary-color); }
        #show-solution-btn { background-color: var(--orange); }
        [data-theme="dark"] #next-question-btn { background: linear-gradient(45deg, var(--ios-blue-dark), #58a0ff); }
        
        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4);
            z-index: 2000; display: grid; place-items: center; padding: 1rem;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s; }
        .modal-content {
            background-color: var(--card-bg);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            color: var(--text-color); padding: 1.5rem; border-radius: 24px;
            width: 100%; max-width: 500px; max-height: 90vh;
            display: flex; flex-direction: column;
            position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .modal-title { flex-grow: 1; text-align: left; font-size: 1.5rem; font-weight: 700;}
        .modal-actions { display: flex; align-items: center; gap: 0.5rem; }
        .modal-close, #download-history-btn, #download-summary-btn {
            font-size: 1.2rem; color: var(--text-secondary-color); cursor: pointer;
            width: 32px; height: 32px; border-radius: 50%; background-color: var(--select-bg);
            display: grid; place-items: center; border: none; transition: background-color 0.2s, color 0.2s;
        }
        .modal-close:hover, #download-history-btn:hover, #download-summary-btn:hover { background-color: var(--text-secondary-color); color: var(--card-bg); }
        
        /* --- HISTORY, SOLUTION, SUMMARY & CHANGELOG MODAL CONTENT --- */
        #history-content-area, #changelog-content { overflow-y: auto; flex-grow: 1; }
        .history-entry { border-bottom: 1px solid var(--border-color); padding: 1.25rem 0.5rem; }
        .history-q { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.75rem; word-wrap: break-word; }
        .history-a { font-size: 1.1rem; }
        .history-entry .solution-indicator { color: var(--yellow); }
        #solution-steps p { padding: 0.5rem 0; font-size: 1.1rem; line-height: 1.6; word-wrap: break-word; }
        #solution-steps p:not(:last-child) { border-bottom: 1px dashed var(--border-color); }
        #solution-steps strong { color: var(--primary-color); font-weight: 700; }
        .summary-stats { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; text-align: left; }
        .summary-stat-item { display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; font-weight: 600; padding: 0.5rem; }
        .summary-stat-item span:last-child { font-weight: 700; font-size: 1.5rem; }
        .modal-footer { margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; }
        .modal-footer button { padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 999px; cursor: pointer; transition: filter 0.2s; }
        #play-again-btn { background-color: var(--primary-color); color: white; }
        #return-to-practice-btn { background-color: var(--select-bg); color: var(--text-color); }
        #changelog-content ul { list-style-type: none; padding-left: 0; }
        #changelog-content li { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; text-align: left; }
        #changelog-content i { color: var(--green); margin-top: 0.25rem; }
        
        /* --- NOTIFICATION BAR --- */
        #notification-bar {
            position: fixed; top: -150px; left: 50%; transform: translateX(-50%);
            padding: 0.8rem 1.5rem; border-radius: 999px; color: white;
            font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 9999; transition: top 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; align-items: center; gap: 0.75rem;
            background-color: var(--card-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        }
        #notification-bar.show { top: 20px; }
        #notification-bar.correct { background-color: var(--green); }
        #notification-bar.wrong { background-color: var(--red); }
        
        /* --- FOOTER --- */
        .app-footer { padding: 2rem 1rem; text-align: center; color: var(--text-secondary-color); font-size: 0.9rem; }
        .app-footer a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        .app-footer a:hover { text-decoration: underline; }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            #question {
                font-size: clamp(1.5rem, 9vw, 3rem); /* FIX: More aggressive scaling for mobile questions */
            }
        }
        @media (max-width: 400px) {
            .options-container { grid-template-columns: 1fr; }
            .game-card { padding-left: 1rem; padding-right: 1rem; }
            .action-btn { padding: 0.8rem 1.5rem; font-size: 1.1rem; }
            .option-btn { font-size: 1.2rem; }
        }
        @media (max-width: 1023px) {
            body { padding-top: var(--header-height-tablet); }
            .header-content { flex-direction: column; align-items: flex-start; justify-content: center; gap: 0.25rem; }
            .scores-group { width: 100%; justify-content: flex-start; }
        }
        @media (min-width: 1024px) {
            html, body { height: 100%; overflow: hidden; padding-top: 0; }
            body { display: flex; flex-direction: row; }
            .app-header { display: none; }
            main { flex-grow: 1; padding: 2rem; display: flex; gap: 2rem; height: 100vh; align-items: stretch;}
            .container { max-width: 100%; padding: 0; display: flex; flex-grow: 1; gap: 2rem; }
            .controls-panel { 
                order: -1; flex: 0 0 380px; height: 100%; margin-bottom: 0; overflow-y: auto; 
                display: flex; flex-direction: column; justify-content: flex-start; padding: 1.5rem;
            }
            .controls-panel .title-group, .controls-panel .scores-group { display: flex; }
            .controls-panel .title-group { padding: 1rem 0; justify-content: center; }
            .controls-panel .scores-group { background: var(--select-bg); padding: 1rem; border-radius: 12px; justify-content: space-around; width: 100%; flex-wrap: wrap;}
            .game-card { flex-grow: 1; height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 2.5rem; }
            #question { font-size: clamp(4rem, 10vh, 7rem); }
            .option-btn { font-size: clamp(1.5rem, 4vh, 2.5rem); }
            .app-footer { display: none; }
        }
    </style>
</head>
<body data-theme="light">
    <div id="notification-bar"><i class="fas"></i> <span id="notification-text"></span></div>

    <header class="app-header">
        <div class="header-content">
            <div class="title-group">
                <i class="fa-solid fa-bolt-lightning logo"></i>
                <h1 class="title">Math Wizard</h1>
            </div>
            <div class="scores-group">
                <div class="score-container"><span id="score-label"></span>: <span class="score-value" id="score-value"></span></div>
                <div class="score-container"><span id="incorrect-score-label"></span>: <span class="score-value" id="incorrect-score-value"></span></div>
                <div class="score-container"><span id="skipped-label"></span>: <span class="score-value" id="skipped-value"></span></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <aside class="controls-panel">
                 <div class="title-group">
                    <i class="fa-solid fa-bolt-lightning logo"></i>
                    <h1 class="title">Math Wizard</h1>
                </div>
                <div class="scores-group">
                    <div class="score-container"><span id="desktop-score-label"></span>: <span class="score-value" id="desktop-score-value"></span></div>
                    <div class="score-container"><span id="desktop-incorrect-score-label"></span>: <span class="score-value" id="desktop-incorrect-score-value"></span></div>
                    <div class="score-container"><span id="desktop-skipped-label"></span>: <span class="score-value" id="desktop-skipped-value"></span></div>
                </div>

                <div class="top-controls">
                    <div class="control-group">
                        <button class="control-btn" id="theme-switch" title="Switch Theme"><i class="fas fa-moon"></i></button>
                        <button class="control-btn" id="lang-switch" title="Change Language"><i class="fa-solid fa-language"></i></button>
                        <button class="control-btn" id="history-btn" title="View History"><i class="fa-solid fa-history"></i></button>
                        <button class="control-btn" id="reset-score-btn" title="Reset Score"><i class="fa-solid fa-rotate-left"></i></button>
                        <button class="control-btn" id="changelog-btn" title="Changelog"><i class="fa-solid fa-info-circle"></i></button>
                    </div>
                    <div class="select-group">
                        <label id="operation-label" for="operation-select"></label>
                        <select id="operation-select"><option value="mix"></option><option value="+"></option><option value="-"></option><option value="×"></option><option value="÷"></option><option value="find-expression"></option></select>
                    </div>
                     <div class="select-group">
                        <label id="difficulty-label" for="difficulty-select"></label>
                        <select id="difficulty-select"><option value="easy"></option><option value="medium"></option><option value="hard"></option><option value="extra-hard"></option></select>
                    </div>
                    <button id="timed-challenge-btn"><i class="fa-solid fa-stopwatch"></i> <span id="timed-challenge-btn-text"></span></button>
                </div>
            </aside>

            <div class="game-card">
                <div id="timer-display"></div>
                <div id="game-area">
                    <h2 id="instruction"></h2>
                    <div id="question"></div>
                    <div class="options-container" id="options-container"></div>
                    <div class="action-buttons">
                        <button id="show-solution-btn" class="action-btn"><i class="fa-solid fa-lightbulb"></i><span id="solution-btn-text"></span></button>
                        <button id="skip-question-btn" class="action-btn"><i class="fa-solid fa-forward"></i><span id="skip-btn-text"></span></button>
                        <button id="next-question-btn" class="action-btn"><i class="fa-solid fa-arrow-right"></i><span id="next-btn-text"></span></button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="history-modal-title" class="modal-title"></h3>
                <div class="modal-actions">
                    <button id="download-history-btn" title="Download History"><i class="fa-solid fa-download"></i></button>
                    <button id="history-modal-close" class="modal-close" title="Close"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div id="history-content-area"></div>
        </div>
    </div>
    
    <div id="solution-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                 <h3 id="solution-modal-title" class="modal-title"></h3>
                 <div class="modal-actions">
                     <button id="solution-modal-close" class="modal-close"><i class="fa-solid fa-xmark"></i></button>
                 </div>
            </div>
            <div id="solution-steps"></div>
        </div>
    </div>

    <div id="time-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="time-select-title" class="modal-title"></h3>
                <div class="modal-actions">
                     <button id="time-select-close" class="modal-close"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="select-group">
                <label id="time-select-label" for="time-select"></label>
                <select id="time-select">
                    <option value="1">1 Minute</option><option value="2">2 Minutes</option><option value="5">5 Minutes</option><option value="10">10 Minutes</option>
                    <option value="15">15 Minutes</option><option value="30">30 Minutes</option><option value="45">45 Minutes</option><option value="60">60 Minutes</option>
                </select>
            </div>
            <div class="modal-footer">
                <button id="start-challenge-btn"></button>
            </div>
        </div>
    </div>

    <div id="summary-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="summary-title" class="modal-title"></h3>
                <div class="modal-actions">
                     <button id="download-summary-btn" title="Download Summary"><i class="fa-solid fa-download"></i></button>
                </div>
            </div>
            <div class="summary-stats">
                <div class="summary-stat-item"><span id="summary-correct-label"></span><span id="summary-correct-value"></span></div>
                <div class="summary-stat-item"><span id="summary-incorrect-label"></span><span id="summary-incorrect-value"></span></div>
                <div class="summary-stat-item"><span id="summary-skipped-label"></span><span id="summary-skipped-value"></span></div>
            </div>
            <div class="modal-footer">
                <button id="return-to-practice-btn"></button>
                <button id="play-again-btn"></button>
            </div>
        </div>
    </div>

    <div id="changelog-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="changelog-title" class="modal-title"></h3>
                <div class="modal-actions">
                     <button id="changelog-close" class="modal-close"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div id="changelog-content"></div>
        </div>
    </div>

    <footer class="app-footer">
        <span id="footer-text-part1"></span> <a href="https://www.instagram.com/sandeepbiswalg" target="_blank" rel="noopener noreferrer" id="footer-credit-link">Sandeep Biswal</a><span id="footer-text-part2"></span>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dom = {
                title: document.querySelector('.title'),
                scoreLabel: document.getElementById('score-label'),
                scoreValue: document.getElementById('score-value'),
                incorrectScoreLabel: document.getElementById('incorrect-score-label'),
                incorrectScoreValue: document.getElementById('incorrect-score-value'),
                skippedLabel: document.getElementById('skipped-label'),
                skippedValue: document.getElementById('skipped-value'),
                
                desktopScoreLabel: document.getElementById('desktop-score-label'),
                desktopScoreValue: document.getElementById('desktop-score-value'),
                desktopIncorrectScoreLabel: document.getElementById('desktop-incorrect-score-label'),
                desktopIncorrectScoreValue: document.getElementById('desktop-incorrect-score-value'),
                desktopSkippedLabel: document.getElementById('desktop-skipped-label'),
                desktopSkippedValue: document.getElementById('desktop-skipped-value'),

                langSwitch: document.getElementById('lang-switch'),
                themeSwitch: document.getElementById('theme-switch'), 
                resetBtn: document.getElementById('reset-score-btn'),
                historyBtn: document.getElementById('history-btn'),
                changelogBtn: document.getElementById('changelog-btn'),
                
                operationLabel: document.getElementById('operation-label'), 
                operationSelect: document.getElementById('operation-select'), 
                difficultyLabel: document.getElementById('difficulty-label'), 
                difficultySelect: document.getElementById('difficulty-select'), 

                instruction: document.getElementById('instruction'), 
                question: document.getElementById('question'), 
                optionsContainer: document.getElementById('options-container'), 
                
                nextBtn: document.getElementById('next-question-btn'),
                nextBtnText: document.getElementById('next-btn-text'),
                skipBtn: document.getElementById('skip-question-btn'), 
                skipBtnText: document.getElementById('skip-btn-text'),
                solutionBtn: document.getElementById('show-solution-btn'),
                solutionBtnText: document.getElementById('solution-btn-text'),
                timedChallengeBtn: document.getElementById('timed-challenge-btn'),
                timedChallengeBtnText: document.getElementById('timed-challenge-btn-text'),

                historyModal: document.getElementById('history-modal'), 
                historyModalClose: document.getElementById('history-modal-close'), 
                historyModalTitle: document.getElementById('history-modal-title'), 
                historyContentArea: document.getElementById('history-content-area'),
                downloadHistoryBtn: document.getElementById('download-history-btn'),

                solutionModal: document.getElementById('solution-modal'),
                solutionModalClose: document.getElementById('solution-modal-close'),
                solutionModalTitle: document.getElementById('solution-modal-title'),
                solutionSteps: document.getElementById('solution-steps'),
                
                notificationBar: document.getElementById('notification-bar'),
                notificationText: document.getElementById('notification-text'),
                footerTextPart1: document.getElementById('footer-text-part1'),
                footerTextPart2: document.getElementById('footer-text-part2'),
                footerCreditLink: document.getElementById('footer-credit-link'),
                
                timeSelectionModal: document.getElementById('time-selection-modal'),
                timeSelectTitle: document.getElementById('time-select-title'),
                timeSelectLabel: document.getElementById('time-select-label'),
                timeSelect: document.getElementById('time-select'),
                startChallengeBtn: document.getElementById('start-challenge-btn'),
                timeSelectClose: document.getElementById('time-select-close'),
                timerDisplay: document.getElementById('timer-display'),
                gameArea: document.getElementById('game-area'),
                
                summaryModal: document.getElementById('summary-modal'),
                summaryTitle: document.getElementById('summary-title'),
                summaryCorrectLabel: document.getElementById('summary-correct-label'),
                summaryCorrectValue: document.getElementById('summary-correct-value'),
                summaryIncorrectLabel: document.getElementById('summary-incorrect-label'),
                summaryIncorrectValue: document.getElementById('summary-incorrect-value'),
                summarySkippedLabel: document.getElementById('summary-skipped-label'),
                summarySkippedValue: document.getElementById('summary-skipped-value'),
                playAgainBtn: document.getElementById('play-again-btn'),
                returnToPracticeBtn: document.getElementById('return-to-practice-btn'),
                downloadSummaryBtn: document.getElementById('download-summary-btn'),
                
                changelogModal: document.getElementById('changelog-modal'),
                changelogTitle: document.getElementById('changelog-title'),
                changelogContent: document.getElementById('changelog-content'),
                changelogClose: document.getElementById('changelog-close'),
            };
            
            let state = { 
                scores: { normal: { correct: 0, incorrect: 0, skipped: 0 } },
                lang: 'english', theme: 'light', difficulty: 'easy', operation: 'mix', answerHistory: [],
                solutionShownThisQuestion: false,
                gameMode: 'normal',
            };
            
            let currentQuestion = {};
            let timedSessionStats = { correct: 0, incorrect: 0, skipped: 0 };
            let timerIntervalId = null;
            const changelogVersion = '1.0';

            const translations = {
                 odia: {
                    title: "ଗଣିତ ବିଜ୍ଞ", scoreLabel: "ସ୍କୋର୍", incorrectLabel: "ଭୁଲ୍", skippedLabel: "ଛାଡିଛନ୍ତି",
                    langText: "English", opLabel: "ପ୍ରକାର:", ops: { mix: "ମିଶ୍ରଣ", "+": "ମିଶାଣ", "-": "ଫେଡାଣ", "×": "ଗୁଣନ", "÷": "ହରଣ", "find-expression": "ସମୀକରଣ ଖୋଜ" },
                    diffLabel: "ସ୍ତର:", diffs: { easy: "ସହଜ", medium: "ମଧ୍ୟମ", hard: "କଠିନ", "extra-hard": "ଅତି କଠିନ" },
                    instruction: "ଆପଣଙ୍କର ଉତ୍ତର ବାଛନ୍ତୁ", nextBtn: "ପରବର୍ତ୍ତୀ", skipBtn: "ଛାଡନ୍ତୁ", solutionBtn: "ସମାଧାନ", timedChallenge: "ସମୟ ଚ୍ୟାଲେଞ୍ଜ",
                    resetConfirm: "ଆପଣ ନିଶ୍ଚିତ ଯେ ଆପଣ ସମସ୍ତ ସ୍କୋର୍ ଏବଂ ଇତିହାସ ପୁନଃ ସେଟ୍ କରିବାକୁ ଚାହୁଁଛନ୍ତି?",
                    historyModalTitle: "ଉତ୍ତର ଇତିହାସ", historyUserAnswer: "ଆପଣଙ୍କ ଉତ୍ତର:", historyCorrectAnswer: "ଠିକ୍ ଉତ୍ତର:", historySkipped: "ଆପଣ ଏହି ପ୍ରଶ୍ନଟିକୁ ଛାଡି ଦେଇଛନ୍ତି", historyNoEntries: "କୌଣସି ଇତିହାସ ନାହିଁ।",
                    solutionModalTitle: "ସମାଧାନର ପଦ୍ଧତି", usedSolution: "ସମାଧାନ ଦେଖାଗଲା", correctNotification: "ବାଃ! ଠିକ୍ ଉତ୍ତର।", wrongNotification: "ଆଉଥରେ ଚେଷ୍ଟା କରନ୍ତୁ!",
                    downloadBtn: "ଇତିହାସ ଡାଉନଲୋଡ୍ କରନ୍ତୁ", footerCredit: { name: "ସନ୍ଦୀପ୍ ବିଶ୍ବାଳ", part2: "'ଙ୍କ ଦ୍ବାରା ନିର୍ମିତ" },
                    timeSelectTitle: "ସମୟ ବାଛନ୍ତୁ", timeSelectLabel: "ଚ୍ୟାଲେଞ୍ଜର ଅବଧି:", startChallenge: "ଚ୍ୟାଲେଞ୍ଜ ଆରମ୍ଭ କରନ୍ତୁ",
                    timeOptions: { "1": "୧ ମିନିଟ୍", "2": "୨ ମିନିଟ୍", "5": "୫ ମିନିଟ୍", "10": "୧୦ ମିନିଟ୍", "15": "୧୫ ମିନିଟ୍", "30": "୩୦ ମିନିଟ୍", "45": "୪୫ ମିନିଟ୍", "60": "୬୦ ମିନିଟ୍" },
                    summaryTitle: "ସମୟ ସମାପ୍ତ!", playAgain: "ପୁଣି ଥରେ ଖେଳନ୍ତୁ", returnToPractice: "ଅଭ୍ୟାସକୁ ଫେରନ୍ତୁ",
                    changelogTitle: "ନୂଆ କ'ଣ ଅଛି!",
                    changelogContent: `<ul>
                        <li><i class="fa-solid fa-stopwatch"></i><div><strong>ସମୟ ଚ୍ୟାଲେଞ୍ଜ:</strong> ଏକ ନୂତନ ଟାଇମଡ୍ ଚ୍ୟାଲେଞ୍ଜ ମୋଡ୍ ସହିତ ନିଜକୁ ପରୀକ୍ଷା କରନ୍ତୁ!</div></li>
                        <li><i class="fa-solid fa-lightbulb"></i><div><strong>ପ୍ରଶ୍ନ ସମାଧାନ:</strong> ପ୍ରତ୍ୟେକ ପ୍ରଶ୍ନ ପାଇଁ ପଦକ୍ଷେପ-ପଦକ୍ଷେପ ସମାଧାନ ଦେଖନ୍ତୁ।</div></li>
                        <li><i class="fa-solid fa-calculator"></i><div><strong>ସମୀକରଣ ଖୋଜନ୍ତୁ:</strong> ଏକ ନୂତନ ଗେମ୍ ମୋଡ୍ ଯେଉଁଥିରେ ଆପଣଙ୍କୁ ଫଳାଫଳ ସହିତ ମେଳ ହେଉଥିବା ସମୀକରଣ ଖୋଜିବାକୁ ପଡିବ।</div></li>
                        <li><i class="fa-solid fa-forward"></i><div><strong>ଛାଡିଥିବା ପ୍ରଶ୍ନ ଟ୍ରାକିଂ:</strong> ଆପଣଙ୍କର ଛାଡିଥିବା ପ୍ରଶ୍ନଗୁଡିକ ବର୍ତ୍ତମାନ ସ୍କୋର ଏବଂ ଇତିହାସରେ ଟ୍ରାକ୍ କରାଯାଏ।</div></li>
                    </ul>`,
                    solutionStrings: {
                        startWith: "ପ୍ରଶ୍ନଟି ହେଉଛି:",
                        bodmas: "ବ ର ହ ଗୁ ମି ଫେ ନିୟମ ଅନୁଯାୟୀ, ପ୍ରଥମେ ବନ୍ଧନୀ ଭିତରେ ଥିବା ଅଂଶକୁ ସମାଧାନ କରନ୍ତୁ:",
                        firstParen: "ପ୍ରଥମ ବନ୍ଧନୀକୁ ସମାଧାନ କରନ୍ତୁ:",
                        secondParen: "ଦ୍ଵିତୀୟ ବନ୍ଧନୀକୁ ସମାଧାନ କରନ୍ତୁ:",
                        nowItBecomes: "ବର୍ତ୍ତମାନ ସମୀକରଣଟି ହେଲା:",
                        simpleAdd: "ଏହା ଏକ ସରଳ ମିଶାଣ ଅଟେ।",
                        simpleSub: "ଏହା ଏକ ସରଳ ଫେଡାଣ ଅଟେ।",
                        simpleMul: "ଏହା ଏକ ସରଳ ଗୁଣନ ଅଟେ।",
                        simpleDiv: "ଏହା ଏକ ସରଳ ହରଣ ଅଟେ।",
                        finalSub: "ବର୍ତ୍ତମାନ ଫଳାଫଳଗୁଡିକୁ ଫେଡାନ୍ତୁ:",
                        finalMul: "ଶେଷରେ, ଉତ୍ତର ପାଇବା ପାଇଁ ଗୁଣନ କରନ୍ତୁ:",
                        finalAnswer: "ତେଣୁ, ଶେଷ ଉତ୍ତର ହେଉଛି:",
                        noSolution: "କ୍ଷମାକରନ୍ତୁ, ଏହି ପ୍ରଶ୍ନ ପ୍ରକାର ପାଇଁ କୌଣସି ସମାଧାନ ଉପଲବ୍ଧ ନାହିଁ।"
                    }
                },
                english: {
                    title: "Math Wizard", scoreLabel: "Score", incorrectLabel: "Wrong", skippedLabel: "Skipped",
                    langText: "ଓଡ଼ିଆ", opLabel: "Type:", ops: { mix: "Mix", "+": "Addition", "-": "Subtraction", "×": "Multiplication", "÷": "Division", "find-expression": "Find Expression" },
                    diffLabel: "Level:", diffs: { easy: "Easy", medium: "Medium", hard: "Hard", "extra-hard": "Extra Hard" },
                    instruction: "Choose your answer", nextBtn: "Next", skipBtn: "Skip", solutionBtn: "Solution", timedChallenge: "Timed Challenge",
                    resetConfirm: "Are you sure you want to reset ALL scores and your history?",
                    historyModalTitle: "Answer History", historyUserAnswer: "Your Answer:", historyCorrectAnswer: "Correct Answer:", historySkipped: "You skipped this question", historyNoEntries: "No history found.",
                    solutionModalTitle: "Solution Steps", usedSolution: "Solution viewed", correctNotification: "Awesome! Correct!", wrongNotification: "Oops, try again!",
                    downloadBtn: "Download History", footerCredit: { part1: "Created by ", name: "Sandeep Biswal" },
                    timeSelectTitle: "Select Time", timeSelectLabel: "Challenge Duration:", startChallenge: "Start Challenge",
                    timeOptions: { "1": "1 Minute", "2": "2 Minutes", "5": "5 Minutes", "10": "10 Minutes", "15": "15 Minutes", "30": "30 Minutes", "45": "45 Minutes", "60": "60 Minutes" },
                    summaryTitle: "Time's Up!", playAgain: "Play Again", returnToPractice: "Return to Practice",
                    changelogTitle: "What's New!",
                    changelogContent: `<ul>
                        <li><i class="fa-solid fa-stopwatch"></i><div><strong>Timed Challenge:</strong> Test yourself with a new timed challenge mode!</div></li>
                        <li><i class="fa-solid fa-lightbulb"></i><div><strong>Question Solutions:</strong> View step-by-step solutions for each question.</div></li>
                        <li><i class="fa-solid fa-calculator"></i><div><strong>Find Expression:</strong> A new game mode where you find the expression that matches the result.</div></li>
                        <li><i class="fa-solid fa-forward"></i><div><strong>Skipped Question Tracking:</strong> Your skipped questions are now tracked in the score and history.</div></li>
                    </ul>`,
                    solutionStrings: {
                        startWith: "The question is:",
                        bodmas: "According to BODMAS/PEMDAS, solve inside the parentheses first:",
                        firstParen: "Solve the first parenthesis:",
                        secondParen: "Solve the second parenthesis:",
                        nowItBecomes: "Now the expression becomes:",
                        simpleAdd: "This is a simple addition.",
                        simpleSub: "This is a simple subtraction.",
                        simpleMul: "This is a simple multiplication.",
                        simpleDiv: "This is a simple division.",
                        finalSub: "Now subtract the results:",
                        finalMul: "Finally, multiply to get the answer:",
                        finalAnswer: "So, the final answer is:",
                        noSolution: "Sorry, no solution available for this question type yet."
                    }
                }
            };
            
            const toOdiaNum = numStr => {
                if (state.lang === 'english' || numStr === null || typeof numStr === 'undefined') {
                    return numStr;
                }
                return String(numStr).replace(/[0-9]/g, d => '୦୧୨୩୪୫୬୭୮୯'[d]);
            };

            const getRandom = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            
            const showNotification = (type) => {
                const T = translations[state.lang]; const isCorrect = type === 'correct';
                dom.notificationBar.className = ``; void dom.notificationBar.offsetWidth;
                dom.notificationBar.classList.add('show', type);
                dom.notificationText.textContent = isCorrect ? T.correctNotification : T.wrongNotification;
                dom.notificationBar.querySelector('i').className = isCorrect ? 'fas fa-check-circle' : 'fas fa-times-circle';
                setTimeout(() => { dom.notificationBar.classList.remove('show'); }, 2500);
            };

            const generateFindExpressionQuestion = () => {
                const levelConfig = {
                    easy: { templates: [() => {const n1=getRandom(2,10), n2=getRandom(2,10); return {str: `${n1} × ${n2}`, val: n1*n2}}, () => {const n1=getRandom(10,50), n2=getRandom(10,50); return {str: `${n1} + ${n2}`, val: n1+n2}}] },
                    medium: { templates: [() => {const n1=getRandom(5,15), n2=getRandom(5,15), n3=getRandom(2,10); return {str: `${n1} × ${n2} - ${n3}`, val: n1*n2-n3}}, () => {const n1=getRandom(50,150), n2=getRandom(20,n1-10); return {str: `${n1} - ${n2}`, val: n1-n2}}] },
                    hard: { templates: [() => {const n1=getRandom(3,9), n2=getRandom(10,25), n3=getRandom(5,15); return {str: `${n1} × (${n2} + ${n3})`, val: n1*(n2+n3)}}, () => {const r=getRandom(20,50),d=getRandom(2,9); return {str: `${r*d} ÷ ${d}`, val: r}}] },
                    'extra-hard':{ templates: [() => { const n1 = getRandom(10,20), n2 = getRandom(20,30), n3 = getRandom(5,15); return {str: `(${n1} + ${n2}) × ${n3}`, val: (n1+n2)*n3 }}, () => {const n1=getRandom(100,300), n2=getRandom(3,7), n3=getRandom(20,50); return {str: `${n1} - ${n2} × ${n3}`, val: n1-n2*n3}}] }
                };

                const config = levelConfig[state.difficulty];
                const correctGen = config.templates[getRandom(0, config.templates.length-1)];
                const correctExp = correctGen();
                const questionNumber = correctExp.val;
                
                const options = new Set([correctExp.str]);
                let tries = 0;
                while (options.size < 4 && tries < 100) {
                    const distractorGen = config.templates[getRandom(0, config.templates.length - 1)];
                    const distractorExp = distractorGen();
                    if (distractorExp.val !== questionNumber && !options.has(distractorExp.str)) {
                        options.add(distractorExp.str);
                    }
                    tries++;
                }
                while(options.size < 4) { options.add(`${questionNumber + getRandom(1,10)} - ${getRandom(1,5)}`); }
                currentQuestion = { text: String(questionNumber), answer: correctExp.str, options: [...options].sort(() => Math.random() - 0.5), type: 'find-expression' };
            };

            const generateStandardQuestion = () => {
                const opMapping = {'+': 'add', '-': 'sub', '×': 'mul', '÷': 'div'};
                const opType = (state.operation === 'mix') ? ['add', 'sub', 'mul', 'div'][getRandom(0, 3)] : opMapping[state.operation];
                
                let questionData;
                const levels = {
                    easy: { addSubRange: [1, 20], mulRange: [1, 10], divAnsRange: [2, 10] },
                    medium: { addSubRange: [10, 100], mulRange: [5, 20], divAnsRange: [5, 20] },
                    hard: { addSubRange: [100, 500], mulRange: [11, 30], divAnsRange: [10, 30] },
                    'extra-hard': { 
                        complex1: () => { const n1 = getRandom(11, 30), n2 = getRandom(11, 30), n3 = getRandom(1, 10); return { n1, n2, n3, op: 'complex1', answer: n1 * (n2 - n3), text: `${n1}(${n2} - ${n3})` }; }, 
                        complex2: () => { const n1=getRandom(10,30),n2=getRandom(10,20),n3=getRandom(20,50),n4=getRandom(100,250); const p1=n1*n2, p2=n3+n4; const fN1=p1>p2?n1:n3, fN2=p1>p2?n2:n4, fN3=p1>p2?n3:n1, fN4=p1>p2?n4:n2; return {n1:fN1,n2:fN2,n3:fN3,n4:fN4,op:'complex2',answer:(fN1*fN2)-(fN3+fN4),text:`(${fN1} × ${fN2}) - (${fN3} + ${fN4})`}; } 
                    }
                };
                
                const level = levels[state.difficulty];
                let chosenOp = opType;
                
                if (state.operation === 'mix' && state.difficulty === 'extra-hard') {
                    chosenOp = ['complex1', 'complex2'][getRandom(0,1)];
                }

                switch (chosenOp) {
                    case 'add': { const n1 = getRandom(level.addSubRange[0], level.addSubRange[1]), n2 = getRandom(level.addSubRange[0], level.addSubRange[1]); questionData = {n1, n2, op: '+', answer: n1+n2, text: `${n1} + ${n2}`}; break; }
                    case 'sub': { const n1 = getRandom(level.addSubRange[0], level.addSubRange[1]), n2 = getRandom(level.addSubRange[0], n1); questionData = {n1, n2, op: '-', answer: n1-n2, text: `${n1} - ${n2}`}; break; }
                    case 'mul': { const n1 = getRandom(level.mulRange[0], level.mulRange[1]), n2 = getRandom(2, 12); questionData = {n1, n2, op: '×', answer: n1*n2, text: `${n1} × ${n2}`}; break; }
                    case 'div': { const ans = getRandom(level.divAnsRange[0], level.divAnsRange[1]), n2=getRandom(2,9); const n1 = ans*n2; questionData = {n1, n2, op: '÷', answer: ans, text: `${n1} ÷ ${n2}`}; break; }
                    case 'complex1': questionData = levels['extra-hard'].complex1(); break;
                    case 'complex2': questionData = levels['extra-hard'].complex2(); break;
                    default: { const n1 = getRandom(1,10), n2 = getRandom(1,10); questionData = {n1, n2, op: '+', answer: n1+n2, text: `${n1} + ${n2}`}; }
                }
                
                const optionSet = new Set([questionData.answer]);
                while (optionSet.size < 4) {
                    const deviation = getRandom(1, 20) * (Math.random() < 0.5 ? -1 : 1);
                    const wrongAnswer = Math.max(0, questionData.answer + deviation);
                    if(wrongAnswer !== questionData.answer) optionSet.add(wrongAnswer);
                }
                currentQuestion = { ...questionData, options: [...optionSet].sort(() => Math.random() - 0.5), type: 'standard' };
            }

            const generateQuestion = () => {
                state.solutionShownThisQuestion = false;
                dom.question.classList.remove('question-animate-in');
                dom.optionsContainer.classList.remove('options-animate-in');
                
                if (state.operation === 'find-expression') {
                    generateFindExpressionQuestion();
                } else {
                    generateStandardQuestion();
                }
                displayQuestion();
            };

            const displayQuestion = () => {
                dom.question.textContent = toOdiaNum(currentQuestion.text);
                dom.optionsContainer.innerHTML = '';
                currentQuestion.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    if (currentQuestion.type === 'find-expression') {
                        const formattedOption = String(option).replace(/×/g, ' × ').replace(/÷/g, ' ÷ ').replace(/\+/g, ' + ').replace(/-/g, ' - ').replace(/\s\s/g, ' ');
                        button.textContent = toOdiaNum(formattedOption);
                        button.style.fontSize = "clamp(1rem, 3vw, 1.8rem)";
                    } else {
                        button.textContent = toOdiaNum(String(option));
                    }
                    button.dataset.value = option;
                    button.addEventListener('click', handleOptionClick);
                    dom.optionsContainer.appendChild(button);
                });
                dom.nextBtn.style.display = 'none'; 
                dom.skipBtn.style.display = 'flex';
                dom.solutionBtn.style.display = currentQuestion.type === 'standard' ? 'flex' : 'none';
                dom.question.classList.add('question-animate-in');
                dom.optionsContainer.classList.add('options-animate-in');
            };
            
            const handleOptionClick = e => {
                const allBtns = dom.optionsContainer.querySelectorAll('.option-btn');
                allBtns.forEach(btn => { btn.classList.add('disabled'); btn.removeEventListener('click', handleOptionClick); });
                const selectedBtn = e.currentTarget;
                const chosenAnswer = currentQuestion.type === 'find-expression' ? selectedBtn.dataset.value : parseInt(selectedBtn.dataset.value, 10);
                const isCorrect = chosenAnswer == currentQuestion.answer;
                
                if(state.gameMode === 'timed') {
                    if (isCorrect) timedSessionStats.correct++; else timedSessionStats.incorrect++;
                    if (isCorrect) {
                        selectedBtn.classList.add('correct');
                        setTimeout(generateQuestion, 500);
                        return;
                    }
                } else {
                    if (isCorrect) state.scores.normal.correct++; else state.scores.normal.incorrect++;
                    state.answerHistory.push({ questionText: currentQuestion.text, userAnswer: chosenAnswer, correctAnswer: currentQuestion.answer, type: currentQuestion.type, status: 'answered', solutionShown: state.solutionShownThisQuestion, timestamp: new Date().toISOString() });
                    saveState();
                    updateAllScoresDisplay();
                }

                selectedBtn.classList.add('selected');
                
                if (isCorrect) { 
                    selectedBtn.classList.add('correct', 'pop-correct');
                    showNotification('correct');
                    dom.solutionBtn.style.display = 'none';
                } else { 
                    selectedBtn.classList.add('wrong', 'shake'); 
                    allBtns.forEach(btn => { if (btn.dataset.value == currentQuestion.answer) btn.classList.add('correct-answer'); }); 
                    showNotification('wrong');
                    dom.solutionBtn.style.display = 'flex';
                }
                
                dom.nextBtn.style.display = 'flex'; 
                dom.skipBtn.style.display = 'none';
            };

            const manageDifficultyOptions = () => {
                const extraHardOption = dom.difficultySelect.querySelector('option[value="extra-hard"]');
                const isMixOrFindExpr = state.operation === 'mix' || state.operation === 'find-expression';
                extraHardOption.style.display = isMixOrFindExpr ? '' : 'none';
                if (!isMixOrFindExpr && state.difficulty === 'extra-hard') {
                    dom.difficultySelect.value = 'hard';
                    state.difficulty = 'hard';
                }
            };

            const saveState = () => { try { localStorage.setItem('sbGanita.state', JSON.stringify(state)); } catch (e) { console.error("Could not save state:", e); } };
            
            const loadState = () => {
                const savedState = localStorage.getItem('sbGanita.state');
                if (savedState) { 
                    try { 
                        const parsed = JSON.parse(savedState);
                        Object.assign(state, parsed);
                        state.scores = {
                            normal: { correct: 0, incorrect: 0, skipped: 0, ...(parsed.scores ? parsed.scores.normal : {}) }
                        };
                        if (!Array.isArray(state.answerHistory)) {
                           state.answerHistory = [];
                        }
                    } catch(e) { 
                        console.error("Failed to load state, starting fresh.", e);
                        state.scores.normal = { correct: 0, incorrect: 0, skipped: 0 };
                        state.answerHistory = [];
                    } 
                }
                const params = new URLSearchParams(window.location.search);
                if (params.get('lang') === 'en') state.lang = 'english'; else if (params.get('lang') === 'or') state.lang = 'odia';
            };

            const resetScores = (confirmReset = true) => { 
                if (confirmReset && !confirm(translations[state.lang].resetConfirm)) return; 
                state.scores.normal = { correct: 0, incorrect: 0, skipped: 0 }; 
                state.answerHistory = []; 
                updateAllScoresDisplay(); 
                saveState(); 
            };
            
            const applyLanguage = () => {
                const T = translations[state.lang];
                document.documentElement.lang = state.lang === 'odia' ? 'or' : 'en';
                [...document.querySelectorAll('.title')].forEach(el => el.textContent = T.title);
                [dom.scoreLabel, dom.desktopScoreLabel].forEach(el => el.textContent = T.scoreLabel);
                [dom.incorrectScoreLabel, dom.desktopIncorrectScoreLabel].forEach(el => el.textContent = T.incorrectLabel);
                [dom.skippedLabel, dom.desktopSkippedLabel].forEach(el => el.textContent = T.skippedLabel);
                dom.operationLabel.textContent = T.opLabel; dom.difficultyLabel.textContent = T.diffLabel;
                dom.instruction.textContent = T.instruction;
                dom.nextBtnText.textContent = T.nextBtn; 
                dom.skipBtnText.textContent = T.skipBtn;
                dom.solutionBtnText.textContent = T.solutionBtn;
                dom.timedChallengeBtnText.textContent = T.timedChallenge;
                dom.downloadHistoryBtn.title = T.downloadBtn;
                dom.footerTextPart1.textContent = T.footerCredit.part1 || '';
                dom.footerCreditLink.textContent = T.footerCredit.name;
                dom.footerTextPart2.textContent = T.footerCredit.part2 || '';
                dom.timeSelectTitle.textContent = T.timeSelectTitle;
                dom.timeSelectLabel.textContent = T.timeSelectLabel;
                dom.startChallengeBtn.textContent = T.startChallenge;
                dom.summaryTitle.textContent = T.summaryTitle;
                dom.summaryCorrectLabel.textContent = T.scoreLabel;
                dom.summaryIncorrectLabel.textContent = T.incorrectLabel;
                dom.summarySkippedLabel.textContent = T.skippedLabel;
                dom.playAgainBtn.textContent = T.playAgain;
                dom.returnToPracticeBtn.textContent = T.returnToPractice;
                dom.changelogTitle.textContent = T.changelogTitle;
                dom.changelogContent.innerHTML = T.changelogContent;
                
                for (const opt of dom.difficultySelect.options) opt.textContent = T.diffs[opt.value];
                for (const opt of dom.operationSelect.options) opt.textContent = T.ops[opt.value];
                for (const opt of dom.timeSelect.options) { opt.textContent = T.timeOptions[opt.value]; }
                dom.historyModalTitle.textContent = T.historyModalTitle;
                dom.solutionModalTitle.textContent = T.solutionModalTitle;
                updateAllScoresDisplay();
            };

            const updateAllScoresDisplay = () => {
                const score = state.scores.normal;
                [dom.scoreValue, dom.desktopScoreValue].forEach(el => el.textContent = toOdiaNum(String(score.correct)));
                [dom.incorrectScoreValue, dom.desktopIncorrectScoreValue].forEach(el => el.textContent = toOdiaNum(String(score.incorrect)));
                [dom.skippedValue, dom.desktopSkippedValue].forEach(el => el.textContent = toOdiaNum(String(score.skipped)));
            };

            const displayHistory = () => {
                const T = translations[state.lang]; dom.historyContentArea.innerHTML = '';
                if (!state.answerHistory || state.answerHistory.length === 0) { 
                    dom.historyContentArea.textContent = T.historyNoEntries; 
                } else {
                    [...state.answerHistory].reverse().forEach(entry => {
                        const entryDiv = document.createElement('div');
                        entryDiv.className = 'history-entry';
                        let historyHTML = '';

                        if (entry.status === 'skipped') {
                            const icon = `<i class="fas fa-forward" style="color: var(--text-secondary-color);"></i>`;
                            historyHTML = `<p class="history-q">${toOdiaNum(entry.questionText)}</p><p class="history-a">${icon} ${T.historySkipped}.<br>${T.historyCorrectAnswer} <span style="color:var(--green)">${toOdiaNum(String(entry.correctAnswer))}</span></p>`;
                        } else {
                            const isCorrect = entry.userAnswer == entry.correctAnswer;
                            const resultIcon = isCorrect ? `<i class="fas fa-check-circle" style="color: var(--green);"></i>` : `<i class="fas fa-times-circle" style="color: var(--red);"></i>`;
                            let userAnswerDisplay = toOdiaNum(String(entry.userAnswer));
                            let correctAnswerDisplay = toOdiaNum(String(entry.correctAnswer));
                            let userAnswerHTML = `<span class="user-answer" style="color:${isCorrect ? 'var(--green)' : 'var(--red)'}">${userAnswerDisplay}</span>`;
                            let correctAnswerHTML = !isCorrect ? `<br>${T.historyCorrectAnswer} <span style="color:var(--green)">${correctAnswerDisplay}</span>` : '';
                            let solutionIndicatorHTML = entry.solutionShown ? ` <span class="solution-indicator" title="${T.usedSolution}"><i class="fa-solid fa-lightbulb"></i></span>` : '';
                            historyHTML = `<p class="history-q">${toOdiaNum(entry.questionText)}</p><p class="history-a">${resultIcon} ${T.historyUserAnswer} ${userAnswerHTML}${correctAnswerHTML}${solutionIndicatorHTML}</p>`;
                        }
                        
                        entryDiv.innerHTML = historyHTML;
                        dom.historyContentArea.appendChild(entryDiv);
                    });
                }
                dom.historyModal.classList.add('visible');
            };

            const generateSolutionHTML = () => {
                const q = currentQuestion;
                const T = translations[state.lang].solutionStrings;
                let steps = [];
                const addStep = (text) => steps.push(`<p>${text}</p>`);
                const qText = toOdiaNum(q.text);

                switch(q.op) {
                    case '+': addStep(`${T.startWith} <strong>${qText}</strong>`); addStep(T.simpleAdd); addStep(`${T.finalAnswer} <strong>${toOdiaNum(String(q.answer))}</strong>.`); break;
                    case '-': addStep(`${T.startWith} <strong>${qText}</strong>`); addStep(T.simpleSub); addStep(`${T.finalAnswer} <strong>${toOdiaNum(String(q.answer))}</strong>.`); break;
                    case '×': addStep(`${T.startWith} <strong>${qText}</strong>`); addStep(T.simpleMul); addStep(`${T.finalAnswer} <strong>${toOdiaNum(String(q.answer))}</strong>.`); break;
                    case '÷': addStep(`${T.startWith} <strong>${qText}</strong>`); addStep(T.simpleDiv); addStep(`${T.finalAnswer} <strong>${toOdiaNum(String(q.answer))}</strong>.`); break;
                    case 'complex1': {
                        const intermediate = q.n2 - q.n3;
                        addStep(`${T.startWith} <strong>${qText}</strong>.`);
                        addStep(`${T.bodmas} <strong>${toOdiaNum(String(q.n2))} - ${toOdiaNum(String(q.n3))} = ${toOdiaNum(String(intermediate))}</strong>.`);
                        addStep(`${T.nowItBecomes} <strong>${toOdiaNum(String(q.n1))} × ${toOdiaNum(String(intermediate))}</strong>.`);
                        addStep(`${T.finalMul} <strong>${toOdiaNum(String(q.answer))}</strong>.`);
                        break;
                    }
                    case 'complex2': {
                        const part1 = q.n1 * q.n2;
                        const part2 = q.n3 + q.n4;
                        addStep(`${T.startWith} <strong>${qText}</strong>.`);
                        addStep(`${T.firstParen} <strong>${toOdiaNum(String(q.n1))} × ${toOdiaNum(String(q.n2))} = ${toOdiaNum(String(part1))}</strong>.`);
                        addStep(`${T.secondParen} <strong>${toOdiaNum(String(q.n3))} + ${toOdiaNum(String(q.n4))} = ${toOdiaNum(String(part2))}</strong>.`);
                        addStep(`${T.finalSub} <strong>${toOdiaNum(String(part1))} - ${toOdiaNum(String(part2))}</strong>.`);
                        addStep(`${T.finalAnswer} <strong>${toOdiaNum(String(q.answer))}</strong>.`);
                        break;
                    }
                    default: addStep(T.noSolution);
                }
                return steps.join('');
            };
            
            const downloadHistory = (isSummary = false) => {
                const data = isSummary ? timedSessionStats : state;
                const history = isSummary ? null : state.answerHistory;
                if (!isSummary && (!history || history.length === 0)) {
                    alert('No history to download!');
                    return;
                }

                let content = `Math Wizard - ${isSummary ? 'Timed Challenge Summary' : 'Full History'}\n=============================\n\n`;
                if (isSummary) {
                    content += `Correct Answers: ${data.correct}\n`;
                    content += `Incorrect Answers: ${data.incorrect}\n`;
                    content += `Skipped Questions: ${data.skipped}\n`;
                } else {
                    history.forEach((entry, index) => {
                        content += `Question #${index + 1}: ${entry.questionText}\n`;
                        if (entry.status === 'skipped') {
                            content += `Status: Skipped\n`;
                        } else {
                            const result = entry.userAnswer == entry.correctAnswer ? "Correct" : "Incorrect";
                            content += `Your Answer: ${entry.userAnswer} (${result})\n`;
                        }
                        content += `Correct Answer: ${entry.correctAnswer}\n`;
                        content += `-------------------------------------\n`;
                    });
                }
                const filename = isSummary ? 'math-wizard-summary.txt' : 'math-wizard-history.txt';
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            const toggleControls = (enabled) => {
                dom.operationSelect.disabled = !enabled;
                dom.difficultySelect.disabled = !enabled;
                dom.timedChallengeBtn.disabled = !enabled;
                dom.timedChallengeBtn.style.opacity = enabled ? '1' : '0.5';
                dom.timedChallengeBtn.style.cursor = enabled ? 'pointer' : 'not-allowed';
            };

            const formatTime = (seconds) => {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                const paddedMinutes = String(minutes).padStart(2, '0');
                const paddedSeconds = String(remainingSeconds).padStart(2, '0');
                return toOdiaNum(`${paddedMinutes}:${paddedSeconds}`);
            };

            const startTimer = (duration) => {
                let timeLeft = duration;
                dom.timerDisplay.textContent = formatTime(timeLeft);
                timerIntervalId = setInterval(() => {
                    timeLeft--;
                    dom.timerDisplay.textContent = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        clearInterval(timerIntervalId);
                        endTimedChallenge();
                    }
                }, 1000);
            };

            const endTimedChallenge = () => {
                state.gameMode = 'normal';
                dom.timerDisplay.style.display = 'none';
                dom.gameArea.classList.add('hidden');
                dom.summaryModal.classList.add('visible');
                
                dom.summaryCorrectValue.textContent = toOdiaNum(String(timedSessionStats.correct));
                dom.summaryIncorrectValue.textContent = toOdiaNum(String(timedSessionStats.incorrect));
                dom.summarySkippedValue.textContent = toOdiaNum(String(timedSessionStats.skipped));
                
                toggleControls(true);
            };
            
            const showChangelog = () => {
                dom.changelogTitle.textContent = translations[state.lang].changelogTitle;
                dom.changelogContent.innerHTML = translations[state.lang].changelogContent;
                dom.changelogModal.classList.add('visible');
            };

            const init = () => {
                loadState(); 
                dom.difficultySelect.value = state.difficulty;
                dom.operationSelect.value = state.operation;
                
                applyLanguage();
                manageDifficultyOptions();

                if (localStorage.getItem('changelogVersionSeen') !== changelogVersion) {
                    showChangelog();
                    localStorage.setItem('changelogVersionSeen', changelogVersion);
                }
                if (!localStorage.getItem('firstVisitTimestamp')) {
                    localStorage.setItem('firstVisitTimestamp', new Date().toISOString());
                }
                const firstVisit = new Date(localStorage.getItem('firstVisitTimestamp')).getTime();
                const fiveDaysInMillis = 5 * 24 * 60 * 60 * 1000;
                if ((Date.now() - firstVisit) > fiveDaysInMillis) {
                    dom.changelogBtn.style.display = 'none';
                }

                document.body.dataset.theme = state.theme;
                dom.themeSwitch.querySelector('i').className = state.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                
                dom.themeSwitch.addEventListener('click', () => { state.theme = (state.theme === 'light' ? 'dark' : 'light'); document.body.dataset.theme = state.theme; dom.themeSwitch.querySelector('i').className = state.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; saveState(); });
                dom.langSwitch.addEventListener('click', () => { state.lang = (state.lang === 'odia' ? 'english' : 'odia'); applyLanguage(); displayQuestion(); saveState(); });
                dom.resetBtn.addEventListener('click', () => resetScores(true));
                dom.nextBtn.addEventListener('click', generateQuestion);
                dom.skipBtn.addEventListener('click', () => {
                    if (state.gameMode === 'timed') {
                        timedSessionStats.skipped++;
                    } else {
                        state.scores.normal.skipped++;
                        state.answerHistory.push({ questionText: currentQuestion.text, userAnswer: null, correctAnswer: currentQuestion.answer, type: currentQuestion.type, status: 'skipped', timestamp: new Date().toISOString() });
                        saveState();
                        updateAllScoresDisplay();
                    }
                    generateQuestion();
                });
                
                dom.difficultySelect.addEventListener('change', (e) => { state.difficulty = e.target.value; manageDifficultyOptions(); saveState(); generateQuestion(); });
                dom.operationSelect.addEventListener('change', (e) => { state.operation = e.target.value; manageDifficultyOptions(); saveState(); generateQuestion(); });
                
                dom.historyBtn.addEventListener('click', displayHistory);
                dom.historyModalClose.addEventListener('click', () => dom.historyModal.classList.remove('visible'));
                dom.historyModal.addEventListener('click', (e) => { if (e.target === dom.historyModal) { dom.historyModal.classList.remove('visible'); } });
                dom.downloadHistoryBtn.addEventListener('click', () => downloadHistory(false));
                
                dom.solutionBtn.addEventListener('click', () => { if (state.gameMode === 'normal') state.solutionShownThisQuestion = true; saveState(); dom.solutionSteps.innerHTML = generateSolutionHTML(); dom.solutionModal.classList.add('visible'); });
                dom.solutionModal.addEventListener('click', (e) => { if (e.target === dom.solutionModal) { dom.solutionModal.classList.remove('visible'); } });
                dom.solutionModalClose.addEventListener('click', () => dom.solutionModal.classList.remove('visible'));

                dom.timedChallengeBtn.addEventListener('click', () => dom.timeSelectionModal.classList.add('visible'));
                dom.timeSelectClose.addEventListener('click', () => dom.timeSelectionModal.classList.remove('visible'));
                dom.timeSelectionModal.addEventListener('click', (e) => { if (e.target === dom.timeSelectionModal) { dom.timeSelectionModal.classList.remove('visible'); } });
                dom.startChallengeBtn.addEventListener('click', () => {
                    dom.timeSelectionModal.classList.remove('visible');
                    state.gameMode = 'timed';
                    timedSessionStats = { correct: 0, incorrect: 0, skipped: 0 };
                    const durationInMinutes = parseInt(dom.timeSelect.value, 10);
                    startTimer(durationInMinutes * 60);
                    toggleControls(false);
                    dom.timerDisplay.style.display = 'block';
                    dom.gameArea.classList.remove('hidden');
                    generateQuestion();
                });
                
                dom.summaryModal.addEventListener('click', (e) => { if (e.target === dom.summaryModal) { dom.summaryModal.classList.remove('visible'); } });
                dom.playAgainBtn.addEventListener('click', () => { dom.summaryModal.classList.remove('visible'); dom.timeSelectionModal.classList.add('visible'); });
                dom.returnToPracticeBtn.addEventListener('click', () => { dom.summaryModal.classList.remove('visible'); dom.gameArea.classList.remove('hidden'); generateQuestion(); });
                dom.downloadSummaryBtn.addEventListener('click', () => downloadHistory(true));
                
                dom.changelogBtn.addEventListener('click', showChangelog);
                dom.changelogClose.addEventListener('click', () => dom.changelogModal.classList.remove('visible'));
                dom.changelogModal.addEventListener('click', (e) => { if (e.target === dom.changelogModal) { dom.changelogModal.classList.remove('visible'); } });

                generateQuestion();
            };

            init();
        });
    </script>
</body>
</html>
