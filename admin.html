<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Odia Games</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        h1, h2, h3 { color: #0a2463; }
        #login-section, #admin-section { display: none; }
        input, textarea, button, select { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem; }
        textarea { min-height: 120px; resize: vertical; font-family: 'Courier New', Courier, monospace; }
        button { background-color: #00693f; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        button:hover { background-color: #004d2b; }
        #logout-btn { background-color: #d9534f; width: auto; display: inline-block; padding: 8px 15px; margin-left: 15px; }
        #logout-btn:hover { background-color: #c9302c; }
        #cancel-edit-btn { background-color: #6c757d; }
        #cancel-edit-btn:hover { background-color: #5a6268; }
        .content-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; flex-wrap: wrap; gap: 10px; cursor: grab; }
        .item-type-tag { font-size: 0.8rem; font-weight: bold; padding: 3px 8px; border-radius: 10px; color: white; margin-right: 10px; }
        .tag-game { background-color: #00693f; }
        .tag-ad { background-color: #ff9f1c; }
        .tag-html-ad { background-color: #007bff; } /* --- ADDED --- */
        .featured-indicator { color: #e67e22; font-weight: bold; margin-left: 5px; }
        .sortable-ghost { background: #c8ebfb; opacity: 0.5; }
        .form-tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 1rem; font-weight: bold; color: #666; }
        .tab-btn.active { color: #0a2463; border-bottom: 3px solid #0a2463; }
        #ad-fields, #html-ad-fields { display: none; }
        label { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        label input[type="checkbox"] { width: auto; margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Panel</h1>
        <div id="login-section">
            <h2>Login</h2>
            <input type="email" id="email" placeholder="Email" />
            <input type="password" id="password" placeholder="Password" />
            <button id="login-btn">Login</button>
            <p id="login-error" style="color: red"></p>
        </div>
        <div id="admin-section">
            <p>Welcome, <strong id="admin-email"></strong>! <button id="logout-btn">Logout</button></p>
            <hr />
            <h2 id="form-title">Add/Edit Content</h2>
            <div class="form-tabs">
                <button class="tab-btn active" onclick="showForm('game')">Game</button>
                <button class="tab-btn" onclick="showForm('ad')">Image Ad</button>
                <!-- --- ADDED: HTML Ad Tab --- -->
                <button class="tab-btn" onclick="showForm('html_ad')">HTML Ad</button>
            </div>
            <form id="content-form">
                <input type="hidden" id="content-id" />
                <input type="hidden" id="content-type" value="game" />
                <div id="game-fields">
                    <input type="text" id="title_en" placeholder="Game Title (English)" required />
                    <input type="text" id="title_or" placeholder="Game Title (Odia)" />
                    <input type="text" id="category_en" placeholder="Category (English)" />
                    <input type="text" id="category_or" placeholder="Category (Odia)" />
                    <input type="url" id="iconUrl" placeholder="Icon Image URL" required />
                    <input type="url" id="gameUrl" placeholder="Game Link URL" required />
                    <div>
                        <label><input type="checkbox" id="isFeatured" /> Mark as "Featured"?</label>
                    </div>
                </div>
                <div id="ad-fields">
                    <input type="text" id="ad_brandName" placeholder="Brand Name" />
                    <input type="url" id="ad_imageUrl" placeholder="Ad Background Image URL" />
                    <input type="text" id="ad_description" placeholder="Ad Description" />
                    <input type="url" id="ad_linkUrl" placeholder="Ad Destination URL" />
                    <input type="text" id="ad_buttonText" placeholder="Button Text" />
                    <label>Button Color: <input type="color" id="ad_buttonColor" value="#FF9F1C" style="padding: 3px; width: 50px; height: 40px; margin-left:10px;"/></label>
                </div>
                <!-- --- ADDED: HTML Ad Form --- -->
                <div id="html-ad-fields">
                    <p>Paste your ad code (e.g., Google AdSense) below. It will be rendered as raw HTML.</p>
                    <textarea id="html_ad_code" placeholder="<script>...</script> or <div>...</div>"></textarea>
                </div>

                <button type="submit" id="submit-btn">Add Game</button>
                <button type="button" id="cancel-edit-btn" style="display: none">Cancel Edit</button>
            </form>
            <hr />
            <h2>Existing Content (Drag to Reorder)</h2>
            <div id="content-list">Loading...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCI8CEVsIm04yshvJVAZqQcElE_G-VaduQ", authDomain: "odia-games-visitor-counter.firebaseapp.com", projectId: "odia-games-visitor-counter" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        const loginSection = document.getElementById("login-section"),
            adminSection = document.getElementById("admin-section"),
            contentList = document.getElementById("content-list"),
            contentForm = document.getElementById("content-form"),
            contentIdInput = document.getElementById("content-id"),
            contentTypeInput = document.getElementById("content-type"),
            submitBtn = document.getElementById("submit-btn"),
            cancelEditBtn = document.getElementById("cancel-edit-btn"),
            gameFields = document.getElementById("game-fields"),
            adFields = document.getElementById("ad-fields"),
            htmlAdFields = document.getElementById("html-ad-fields"); // --- ADDED ---

        let allContentData = {}, sortableInstance = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                loginSection.style.display = "none";
                adminSection.style.display = "block";
                document.getElementById("admin-email").textContent = user.email;
                loadContent();
            } else {
                loginSection.style.display = "block";
                adminSection.style.display = "none";
            }
        });

        document.getElementById("login-btn").addEventListener("click", () => {
            auth.signInWithEmailAndPassword(document.getElementById("email").value, document.getElementById("password").value)
                .catch(e => document.getElementById("login-error").textContent = e.message);
        });

        document.getElementById("logout-btn").addEventListener("click", () => auth.signOut());

        contentForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = contentIdInput.value;
            const type = contentTypeInput.value;
            let data = { type, createdAt: firebase.firestore.FieldValue.serverTimestamp() };

            if (type === 'game') {
                Object.assign(data, {
                    title_en: document.getElementById("title_en").value,
                    title_or: document.getElementById("title_or").value,
                    category_en: document.getElementById("category_en").value,
                    category_or: document.getElementById("category_or").value,
                    iconUrl: document.getElementById("iconUrl").value,
                    gameUrl: document.getElementById("gameUrl").value,
                    isFeatured: document.getElementById("isFeatured").checked, // --- ADDED ---
                });
            } else if (type === 'ad') {
                Object.assign(data, {
                    brandName: document.getElementById("ad_brandName").value,
                    imageUrl: document.getElementById("ad_imageUrl").value,
                    description: document.getElementById("ad_description").value,
                    linkUrl: document.getElementById("ad_linkUrl").value,
                    buttonText: document.getElementById("ad_buttonText").value,
                    buttonColor: document.getElementById("ad_buttonColor").value,
                });
            } else if (type === 'html_ad') { // --- ADDED ---
                Object.assign(data, {
                    htmlCode: document.getElementById("html_ad_code").value
                });
            }

            try {
                if (id) {
                    await db.collection("content").doc(id).update(data);
                    alert("Content updated!");
                } else {
                    data.order = Object.keys(allContentData).length; // Set initial order
                    await db.collection("content").add(data);
                    alert("Content added!");
                }
                resetForm();
                loadContent();
            } catch (error) {
                console.error("Error saving content: ", error);
                alert("Error saving content. Check console for details.");
            }
        });
        
        async function reIndexOnDrag() {
            const items = Array.from(contentList.children).map(el => el.dataset.id);
            const batch = db.batch();
            items.forEach((id, index) => {
                batch.update(db.collection("content").doc(id), { order: index });
            });
            try { await batch.commit(); } catch (e) { console.error("Error re-indexing: ", e); }
        }

        async function reIndexOnDelete() {
            const snapshot = await db.collection("content").orderBy("order", "asc").get();
            const batch = db.batch();
            snapshot.docs.forEach((doc, index) => {
                batch.update(doc.ref, { order: index });
            });
            await batch.commit();
        }

        async function loadContent() {
            contentList.innerHTML = "Loading...";
            try {
                const snapshot = await db.collection("content").orderBy("order", "asc").get();
                contentList.innerHTML = "";
                allContentData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allContentData[doc.id] = data;
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "content-list-item";
                    itemDiv.dataset.id = doc.id;

                    let tag = '', title = '', featured = '';
                    if (data.type === 'game') {
                        tag = '<span class="item-type-tag tag-game">Game</span>';
                        title = data.title_en || "Untitled Game";
                        if (data.isFeatured) {
                            featured = '<span class="featured-indicator">â˜… Featured</span>';
                        }
                    } else if (data.type === 'ad') {
                        tag = '<span class="item-type-tag tag-ad">Image Ad</span>';
                        title = data.brandName || "Untitled Ad";
                    } else if (data.type === 'html_ad') { // --- ADDED ---
                        tag = '<span class="item-type-tag tag-html-ad">HTML Ad</span>';
                        title = "Embedded Ad Code";
                    }

                    itemDiv.innerHTML = `
                        <span class="content-list-item-name">${tag} ${title} ${featured}</span>
                        <div class="content-list-buttons">
                            <button class="edit-btn" data-id="${doc.id}">Edit</button>
                            <button class="delete-btn" data-id="${doc.id}">Delete</button>
                        </div>`;
                    contentList.appendChild(itemDiv);
                });
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(contentList, { animation: 150, ghostClass: 'sortable-ghost', onEnd: reIndexOnDrag });
            } catch (error) {
                console.error(error);
                contentList.innerHTML = `<p style="color:red; padding: 15px; background: #ffebee;">Could not load content.</p>`;
            }
        }
        
        contentList.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;

            if (e.target.classList.contains("delete-btn")) {
                if (confirm("Are you sure?")) {
                    try {
                        await db.collection("content").doc(id).delete();
                        alert("Deleted!");
                        await reIndexOnDelete();
                        loadContent();
                    } catch (error) { console.error("Error deleting item: ", error); }
                }
            } else if (e.target.classList.contains("edit-btn")) {
                const data = allContentData[id];
                if (data) {
                    resetForm();
                    contentIdInput.value = id;
                    showForm(data.type);
                    if (data.type === 'game') {
                        Object.keys(data).forEach(key => {
                            const el = document.getElementById(key);
                            if (el) { el.type === 'checkbox' ? el.checked = data[key] : el.value = data[key]; }
                        });
                    } else if (data.type === 'ad') {
                        Object.keys(data).forEach(key => {
                            const el = document.getElementById(`ad_${key}`);
                            if (el) { el.value = data[key]; }
                        });
                    } else if (data.type === 'html_ad') { // --- ADDED ---
                        document.getElementById('html_ad_code').value = data.htmlCode || '';
                    }

                    document.getElementById("form-title").textContent = "Edit Content";
                    submitBtn.textContent = "Update Content";
                    cancelEditBtn.style.display = "block";
                    window.scrollTo({ top: 0, behavior: "smooth" });
                }
            }
        });
        
        function resetForm() {
            contentForm.reset();
            contentIdInput.value = "";
            cancelEditBtn.style.display = "none";
            const type = contentTypeInput.value;
            submitBtn.textContent = "Add " + (type === 'game' ? 'Game' : (type === 'ad' ? 'Image Ad' : 'HTML Ad'));
            document.getElementById("form-title").textContent = "Add/Edit Content";
            showForm(type);
        }

        cancelEditBtn.addEventListener("click", resetForm);

        function showForm(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="showForm('${type}')"]`).classList.add('active');
            
            contentTypeInput.value = type;
            gameFields.style.display = 'none';
            adFields.style.display = 'none';
            htmlAdFields.style.display = 'none'; // --- ADDED ---
            
            const isEditing = !!contentIdInput.value;
            let buttonText = isEditing ? 'Update' : 'Add';

            if (type === 'game') {
                gameFields.style.display = 'block';
                buttonText += ' Game';
            } else if (type === 'ad') {
                adFields.style.display = 'block';
                buttonText += ' Image Ad';
            } else if (type === 'html_ad') { // --- ADDED ---
                htmlAdFields.style.display = 'block';
                buttonText += ' HTML Ad';
            }
            submitBtn.textContent = buttonText;
        }
    </script>
</body>
</html>
