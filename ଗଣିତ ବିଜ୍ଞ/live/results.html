<!DOCTYPE html>
<html lang="or">
<head>
    <meta charset="UTF-8">
    <!-- ESSENTIAL: Added viewport meta tag for responsiveness -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ଫଳାଫଳ - Game Results</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Oriya:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0A2463; --secondary-color: #3E92CC; --accent-color: #FF9F1C; --success-color: #28a745; --danger-color: #dc3545; --text-light: #FFFFFF; --text-dark: #121212; --bg-light: #F4F7FC; --card-bg: #FFFFFF; --shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        
        /* General body styles */
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-light); color: var(--text-dark); margin: 0; padding: 1rem; }
        body.or-lang { font-family: 'Noto Sans Oriya', sans-serif; }
        .container { max-width: 900px; margin: 0 auto; }
        .main-card { background-color: var(--card-bg); padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow); }
        h1 { font-size: 1.8rem; }
        h1, h2, h3 { color: var(--primary-color); text-align: center; margin-bottom: 1.5rem; }
        
        /* Language switcher */
        .lang-switcher { display: flex; justify-content: center; margin-bottom: 2rem; gap: 10px; }
        .lang-switcher button { background: #eee; border: none; padding: 0.5rem 1rem; cursor: pointer; border-radius: 20px; font-family: inherit; }
        .lang-switcher button.active { background-color: var(--accent-color); color: white; font-weight: bold; }
        
        /* Room list card */
        .room-card { display: flex; flex-direction: column; gap: 0.5rem; justify-content: space-between; align-items: center; background: #fdfdfd; border: 1px solid #eee; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .room-info strong { font-size: 1.2rem; }
        .btn { background-color: var(--accent-color); color: var(--text-light); padding: 0.6rem 1.5rem; border-radius: 20px; border: none; cursor: pointer; text-align: center; width: 100%; max-width: 200px; }
        
        /* General table styles */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { padding: 0.8rem; border: 1px solid #ddd; text-align: left; vertical-align: middle; }
        th { background-color: var(--secondary-color); color: var(--text-light); }
        
        /* Player details styles */
        .details-toggle { cursor: pointer; color: var(--primary-color); font-weight: bold; text-decoration: underline; }
        .player-details-row { display: none; }
        .player-details { background-color: #f9f9f9; padding: 1rem; margin-top: -1px; border: 1px solid #ddd; }
        .player-details ul { list-style: none; padding: 0; }
        .player-details li { padding: 0.5rem; border-bottom: 1px solid #eee; }
        .correct-ans { color: var(--success-color); }
        .wrong-ans { color: var(--danger-color); }

        /* --- RESPONSIVE STYLES for mobile phones --- */
        @media (min-width: 600px) {
            .room-card { flex-direction: row; }
            .btn { width: auto; }
        }

        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            .main-card { padding: 1rem; }
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.3rem; }
            h3 { font-size: 1.2rem; }
            
            /* Responsive tables */
            table { border: 0; }
            table thead {
                border: none;
                clip: rect(0 0 0 0);
                height: 1px;
                margin: -1px;
                overflow: hidden;
                padding: 0;
                position: absolute;
                width: 1px;
            }
            table tr {
                border-bottom: 3px solid var(--secondary-color);
                display: block;
                margin-bottom: .625em;
            }
            table td {
                border-bottom: 1px solid #ddd;
                display: block;
                font-size: .8em;
                text-align: right; /* Align cell content to the right */
            }
            table td::before {
                /* Use data-label for the text, coming from JS */
                content: attr(data-label);
                float: left; /* Float the label to the left */
                font-weight: bold;
                text-transform: uppercase;
            }
            table td:last-child {
                border-bottom: 0;
            }
            /* Make details span full width */
            .player-details-row td {
                padding: 0;
            }
            /* Reset alignment for player details list items */
            .player-details li {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <h1 data-key="results_panel_title"></h1>
            <div class="lang-switcher"> <button id="lang-or"></button> <button id="lang-en"></button> </div>
            <a href="index.html" class="home-link-btn" data-key="back_to_home" style="display: block; text-align: center; margin-bottom: 2rem; color: var(--primary-color); text-decoration: underline;"></a>
            <div id="room-list-container"></div>
            <div id="results-display-area"></div>
        </div>
    </div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyAYurYfkcGSbRmLNBtXmX60iml5ty8-ipI",
      authDomain: "sbg-math-game.firebaseapp.com",
      databaseURL: "https://sbg-math-game-default-rtdb.firebaseio.com",
      projectId: "sbg-math-game",
      storageBucket: "sbg-math-game.firebasestorage.app",
      messagingSenderId: "520015027553",
      appId: "1:520015027553:web:17c396b24da3fa6e8f3920",
      measurementId: "G-S9KFTEQZ9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const translations = {
        or: { lang_btn: "ଓଡ଼ିଆ", results_panel_title: "ଫଳାଫଳ ପ୍ୟାନେଲ୍", available_rooms: "ଉପଲବ୍ଧ ସମାପ୍ତ ଗେମ୍", no_rooms: "କୌଣସି ସମାପ୍ତ ଗେମ୍ ମିଳିଲା ନାହିଁ |", back_to_home: "ହୋମ୍ ପେଜକୁ ଫେରନ୍ତୁ |", check_results: "ଫଳାଫଳ ଦେଖନ୍ତୁ", loading_msg: "ଲୋଡ୍ କରୁଛି...", results_for: "ପାଇଁ ଫଳାଫଳ", final_scores: "ଅନ୍ତିମ ସ୍କୋର୍", rank: "ରାଙ୍କ୍", name: "ନାମ", score: "ସ୍କୋର୍", details: "ବିବରଣୀ", answer_key: "ଉତ୍ତର ସୂଚୀ", question: "ପ୍ରଶ୍ନ", correct_answer: "ସଠିକ୍ ଉତ୍ତର", player_report_for: "ପାଇଁ ଖେଳାଳି ରିପୋର୍ଟ", your_answer: "ଆପଣଙ୍କ ଉତ୍ତର", correct: "ସଠିକ୍", incorrect: "ଭୁଲ", unanswered: "ଉତ୍ତର ଦିଆଯାଇନାହିଁ", password_label: "ରୁମ୍ ପାସୱାର୍ଡ (ବୈକଳ୍ପିକ)", password_error: "ଭୁଲ୍ ପାସୱାର୍ଡ |" },
        en: { lang_btn: "English", results_panel_title: "Results Panel", available_rooms: "Available Finished Games", no_rooms: "No finished games found.", back_to_home: "Back to Home Page", check_results: "Check Results", loading_msg: "Loading...", results_for: "Results for", final_scores: "Final Scores", rank: "Rank", name: "Name", score: "Score", details: "Details", answer_key: "Answer Key", question: "Question", correct_answer: "Correct Answer", player_report_for: "Player Report for", your_answer: "Your Answer", correct: "Correct", incorrect: "Incorrect", unanswered: "Unanswered", password_label: "Room Password (Optional)", password_error: "Incorrect password." }
    };
    const dom = {};
    ['lang-or', 'lang-en', 'room-list-container', 'results-display-area'].forEach(id => dom[id.replace(/-/g, '_')] = document.getElementById(id));
    const toOdiaNumerals = s => String(s).replace(/[0-9]/g, d => '୦୧୨୩୪୫୬୭୮୯'[d]);
    const displayNum = n => document.documentElement.lang === 'or' ? toOdiaNumerals(n) : String(n);
    const setLanguage = (lang) => { document.documentElement.lang = lang; document.body.className = `${lang}-lang`; document.querySelectorAll('[data-key]').forEach(el => { const t = translations[lang]?.[el.dataset.key]; if (t) el.innerHTML = t; }); dom.lang_or.textContent = translations.or.lang_btn; dom.lang_en.textContent = translations.en.lang_btn; dom.lang_or.classList.toggle('active', lang === 'or'); dom.lang_en.classList.toggle('active', lang === 'en'); loadRooms(); };

    async function loadRooms() {
        const lang = document.documentElement.lang;
        dom.room_list_container.innerHTML = `<h2 data-key="available_rooms">${translations[lang].available_rooms}</h2><p>${translations[lang].loading_msg}</p>`;
        dom.results_display_area.innerHTML = '';
        
        try {
            const roomsRef = db.ref('rooms').orderByChild('status').equalTo('finished');
            const snapshot = await roomsRef.get();
            
            dom.room_list_container.innerHTML = `<h2 data-key="available_rooms">${translations[lang].available_rooms}</h2>`;
            
            if (!snapshot.exists()) {
                dom.room_list_container.innerHTML += `<p data-key="no_rooms">${translations[lang].no_rooms}</p>`;
                return;
            }
            
            let roomsHTML = '';
            let roomsArray = [];
            snapshot.forEach(childSnapshot => {
                roomsArray.push({ key: childSnapshot.key, val: childSnapshot.val() });
            });
            roomsArray.sort((a, b) => b.val.createdAt - a.val.createdAt);

            roomsArray.forEach(room => {
                const roomCode = room.key;
                roomsHTML += `<div class="room-card"><div class="room-info"><strong>${roomCode}</strong></div><button class="btn check-result-btn" data-roomcode="${roomCode}" data-key="check_results">${translations[lang].check_results}</button></div>`;
            });

            dom.room_list_container.innerHTML += roomsHTML;
            document.querySelectorAll('.check-result-btn').forEach(b => b.onclick = handleCheckResult);
        } catch (error) {
            console.error("Error loading rooms:", error);
            dom.room_list_container.innerHTML += `<p style="color:red;">Error loading rooms. Check console and Firebase rules.</p>`;
        }
    }

    async function handleCheckResult(event) {
        const roomCode = event.target.dataset.roomcode;
        const snapshot = await db.ref(`rooms/${roomCode}`).get();
        if (!snapshot.exists()) { alert('Room not found!'); return; }
        const roomData = snapshot.val();
        
        const lang = document.documentElement.lang;
        dom.results_display_area.innerHTML = '';
        
        if (roomData.password) { const pass = prompt(`${translations[lang].password_label} for "${roomCode}":`); if (pass !== roomData.password) { alert(translations[lang].password_error); return; } }
        
        if (!roomData || roomData.status !== 'finished' || !roomData.results || !roomData.questions) {
            dom.results_display_area.innerHTML = `<h2>Error</h2><p>This room's data is incomplete or the game has not finished.</p>`;
            return;
        }
        
        const questions = roomData.questions;
        const sortedResults = Object.values(roomData.results).sort((a, b) => b.score - a.score);
        
        // MODIFICATION: Add data-label attributes to TDs for responsive design
        let resultsHTML = `<h2>${translations[lang].results_for} ${roomCode}</h2><h3 data-key="final_scores">${translations[lang].final_scores}</h3><table><thead><tr><th data-key="rank">${translations[lang].rank}</th><th data-key="name">${translations[lang].name}</th><th data-key="score">${translations[lang].score}</th><th></th></tr></thead><tbody>`;
        sortedResults.forEach((player, i) => {
            resultsHTML += `<tr>
                <td data-label="${translations[lang].rank}">${displayNum(i + 1)}</td>
                <td data-label="${translations[lang].name}">${player.name}</td>
                <td data-label="${translations[lang].score}">${displayNum(player.score)}/${displayNum(roomData.settings.q_count)}</td>
                <td data-label="${translations[lang].details}"><span class="details-toggle" data-player-index="${i}" data-key="details">${translations[lang].details}</span></td>
            </tr>
            <tr class="player-details-row" id="details-row-${i}"><td colspan="4"><div class="player-details" id="details-content-${i}"></div></td></tr>`;
        });
        resultsHTML += `</tbody></table><h3 data-key="answer_key">${translations[lang].answer_key}</h3><table><thead><tr><th>#</th><th data-key="question">${translations[lang].question}</th><th data-key="correct_answer">${translations[lang].correct_answer}</th></tr></thead><tbody>`;
        questions.forEach((q, i) => { 
            const qText = q.question.split(' ').map(p => isNaN(p) ? p : displayNum(p)).join(' '); 
            resultsHTML += `<tr>
                <td data-label="#">${displayNum(i+1)}</td>
                <td data-label="${translations[lang].question}">${qText}</td>
                <td data-label="${translations[lang].correct_answer}">${displayNum(q.answer)}</td>
            </tr>`; 
        });
        resultsHTML += `</tbody></table>`;
        dom.results_display_area.innerHTML = resultsHTML;

        document.querySelectorAll('.details-toggle').forEach(toggle => {
            toggle.onclick = () => {
                const playerIndex = toggle.dataset.playerIndex;
                const detailsRow = document.getElementById(`details-row-${playerIndex}`);
                if (detailsRow.style.display === 'block') { // Changed from table-row to block for responsive layout
                    detailsRow.style.display = 'none'; return; 
                }

                const detailsContentDiv = detailsRow.querySelector('.player-details');
                const player = sortedResults[playerIndex];
                let detailsContent = `<h4>${translations[lang].player_report_for} ${player.name}</h4><ul>`;
                const playerAnswers = player.answers || [];
                questions.forEach((q, i) => {
                    const playerAnswerObj = playerAnswers.find(a => a.qIndex === i);
                    let answerText, qText = q.question.split(' ').map(p => isNaN(p) ? p : displayNum(p)).join(' ');
                    if (!playerAnswerObj || playerAnswerObj.answer === null) { answerText = `<span class="wrong-ans">${translations[lang].unanswered}</span>`; }
                    else if (playerAnswerObj.answer === q.answer) { answerText = `<span class="correct-ans">${translations[lang].correct}</span>`; }
                    else { answerText = `<span class="wrong-ans">${translations[lang].incorrect}</span> (${translations[lang].your_answer}: ${displayNum(playerAnswerObj.answer)})`; }
                    detailsContent += `<li><strong>${displayNum(i+1)}. ${qText}</strong> = ${displayNum(q.answer)} | ${answerText}</li>`;
                });
                detailsContent += `</ul>`;
                detailsContentDiv.innerHTML = detailsContent;
                
                document.querySelectorAll('.player-details-row').forEach(row => row.style.display = 'none');
                detailsRow.style.display = 'block'; // Changed from table-row to block for responsive layout
            };
        });
    }

    const init = () => {
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_")) {
            document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red; font-size: 1.2rem;"><h1>Configuration Error</h1><p>Firebase keys are missing. Please paste your firebaseConfig object into results.html.</p></div>`;
            return;
        }
        setLanguage('or');
    };
    
    dom.lang_or.onclick = () => setLanguage('or');
    dom.lang_en.onclick = () => setLanguage('en');
    
    init();
});
</script>
</body>
</html>
