<!DOCTYPE html>
<html lang="or">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SB ମୋ ଓଡ଼ିଆ ଗେମ୍ସ - Room</title>
    <meta name="description" content="ଓଡ଼ିଆରେ ଗଣିତ ଗେମ୍ ଖେଳନ୍ତୁ | Create or join a game room and play live with friends in Odia.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Oriya:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0A2463; --secondary-color: #3E92CC; --accent-color: #FF9F1C; --success-color: #28a745; --danger-color: #dc3545; --text-light: #FFFFFF; --text-dark: #121212; --bg-light: #F4F7FC; --card-bg: #FFFFFF; --shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--bg-light); color: var(--text-dark); line-height: 1.6; font-family: 'Poppins', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        body.or-lang { font-family: 'Noto Sans Oriya', sans-serif; }
        .container { max-width: 650px; margin: 0 auto; padding: 0 20px; }
        header { background-color: var(--primary-color); color: var(--text-light); padding: 1rem 0; position: sticky; top: 0; z-index: 1000; }
        header .container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.2rem; font-weight: 700; color: var(--text-light); text-decoration: none; }
        nav { display: flex; align-items: center; gap: 1.5rem; }
        nav a { color: var(--text-light); text-decoration: none; font-weight: 600; }
        nav a:hover { color: var(--accent-color); }
        .lang-switcher button { background: none; border: none; color: var(--text-light); padding: 0.5rem 1rem; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s ease; font-family: inherit; border-radius: 20px; }
        .lang-switcher button.active { background-color: var(--accent-color); font-weight: 700; }
        main { flex-grow: 1; }
        .game-screen { display: none; padding: 2rem 0; animation: fadeIn 0.5s; }
        .game-screen.active { display: block; }
        .game-card { background-color: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); text-align: center; padding: 1.5rem 2rem; }
        .game-card h1 { font-size: 2rem; color: var(--primary-color); margin-bottom: 0.5rem; }
        #results-room-code { font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color); }
        .form-group input, .form-group select { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        .room-code-input-group { display: flex; align-items: center; }
        .room-code-prefix { background-color: #eee; padding: 0.8rem; border: 1px solid #ccc; border-right: none; border-radius: 8px 0 0 8px; font-weight: bold; color: var(--primary-color); }
        .room-code-input-group input { border-radius: 0 8px 8px 0; }
        .btn { display: inline-block; background-color: var(--accent-color); color: var(--text-light); padding: 0.8rem 2rem; border-radius: 25px; text-decoration: none; font-weight: 700; transition: all 0.3s ease; border: none; cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 0.5rem; }
        .btn:hover:not(:disabled) { background-color: #e68a00; transform: translateY(-2px); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-group { display: flex; gap: 1rem; flex-direction: column; }
        .error-message { color: var(--danger-color); font-weight: bold; margin-top: 1rem; min-height: 1.2em; }
        .back-btn { background: none; border: none; color: var(--secondary-color); cursor: pointer; font-size: 0.9rem; margin-top: 1rem; }
        #player-list { list-style: none; margin: 1rem 0; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        #player-list li { padding: 0.75rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #player-list li:last-child { border-bottom: none; }
        .remove-player-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.5rem; font-weight: bold; padding: 0 0.5rem; line-height: 1; }
        .remove-player-btn:hover { opacity: 0.7; }
        #host-controls, #guest-info, #share-controls { border-top: 2px solid var(--bg-light); padding-top: 1.5rem; margin-top: 1.5rem; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .setting-display { background-color: var(--bg-light); padding: 0.5rem 1rem; border-radius: 8px; text-align: left; }
        .setting-display strong { color: var(--primary-color); }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-weight: bold; }
        #main-timer { font-size: 1.2rem; color: var(--danger-color); }
        #question-container { font-size: 2.5rem; margin-bottom: 2rem; min-height: 80px; font-weight: 700; }
        footer { background-color: var(--primary-color); color: var(--text-light); padding: 1.5rem 0; text-align: center; margin-top: auto; }
        footer a { color: var(--accent-color); text-decoration: none; font-weight: bold; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        #progress-bar-container { width: 100%; background-color: #ddd; border-radius: 5px; margin-bottom: 1rem; } #progress-bar { width: 0%; height: 10px; background-color: var(--accent-color); border-radius: 5px; transition: width 0.3s; } #timer { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; } .answer-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; } .answer-btn { width: 100%; padding: 1rem; font-size: 1.1rem; } .answer-btn.correct { background-color: var(--success-color); color: white; } .answer-btn.incorrect { background-color: var(--danger-color); color: white; }
        #results-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        #results-table th, #results-table td { padding: 0.8rem; border: 1px solid #ddd; text-align: left; }
        #results-table th { background-color: var(--secondary-color); color: var(--text-light); }
        #answer-key-btn { margin-bottom: 1rem; }
        #download-report-btn { margin-bottom: 1.5rem; background-color: var(--success-color); }
        #answer-key-container { display: none; text-align: left; max-height: 400px; overflow-y: auto; }
        #answer-key-container table { font-size: 0.9rem; }
    </style>
</head>
<body>
    <header>
        <div class="container"> 
            <a href="https://imsbg.github.io/odiagames/" class="logo" data-key="logo_text"></a> 
            <nav>
                <a href="#" class="home-link" data-key="home_btn"></a>
                <a href="https://imsbg.github.io/odiagames/ଗଣିତ%20ବିଜ୍ଞ/" data-key="other_games_btn"></a>
                <div class="lang-switcher"> <button id="lang-or"></button> <button id="lang-en"></button> </div>
            </nav>
        </div> 
    </header>
    <main>
        <section id="landing-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="welcome"></h1> <div class="btn-group"> <button id="show-create-btn" class="btn" data-key="create_room_btn"></button> <button id="show-join-btn" class="btn btn-secondary" data-key="join_room_btn"></button> <a href="results.html" class="btn btn-secondary" style="background-color: #555;" data-key="check_results_btn"></a> </div> </div></div> </section>
        <section id="create-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="create_title"></h1> <div class="form-group"> <label for="create-player-name" data-key="name_label"></label> <input type="text" id="create-player-name"> </div> <div class="form-group"> <label for="create-password" data-key="password_label"></label> <input type="text" id="create-password" inputmode="numeric"> </div> <button id="create-btn" class="btn" data-key="create_btn"></button> <div id="create-error" class="error-message"></div> <button class="back-btn" data-screen="landing-screen">← <span data-key="back_btn"></span></button> </div></div> </section>
        <section id="join-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="join_title"></h1> <div class="form-group"> <label for="join-room-code-num" data-key="room_code_label"></label> <div class="room-code-input-group"><span class="room-code-prefix">SB</span><input type="text" id="join-room-code-num" inputmode="numeric" maxlength="4"></div> </div> <div class="form-group"> <label for="join-player-name" data-key="name_label"></label> <input type="text" id="join-player-name"> </div> <div class="form-group"> <label for="join-password" data-key="password_label"></label> <input type="text" id="join-password" inputmode="numeric"> </div> <button id="join-btn" class="btn" data-key="join_btn"></button> <div id="join-error" class="error-message"></div> <button class="back-btn" data-screen="landing-screen">← <span data-key="back_btn"></span></button> </div></div> </section>
        <section id="lobby-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="lobby_title"></h1> <h2><span data-key="room_code_display"></span> <strong id="lobby-room-code" style="color: var(--accent-color);"></strong></h2> <h3 data-key="players_in_room"></h3> <ul id="player-list"></ul> <div id="host-controls" style="display: none;"> <h3 data-key="game_settings_title"></h3> <div class="settings-grid"> <div class="form-group"><label for="game-timer" data-key="total_time_label"></label><select id="game-timer"></select></div> <div class="form-group"><label for="question-count" data-key="q_count_label"></label><select id="question-count"></select></div> <div class="form-group"><label for="game-type" data-key="game_type_label"></label><select id="game-type"></select></div> <div class="form-group"><label for="game-difficulty" data-key="difficulty_label"></label><select id="game-difficulty"></select></div> </div> <button id="start-game-btn" class="btn" data-key="start_game_btn" disabled></button> <small id="start-game-info" data-key="start_game_info"></small> </div> <div id="guest-info" style="display: none;"> <h3 data-key="game_settings_title"></h3> <div class="settings-grid"> <div class="setting-display"><strong><span data-key="total_time_label"></span>:</strong> <span id="guest-game-timer"></span></div> <div class="setting-display"><strong><span data-key="q_count_label"></span>:</strong> <span id="guest-question-count"></span></div> <div class="setting-display"><strong><span data-key="game_type_label"></span>:</strong> <span id="guest-game-type"></span></div> <div class="setting-display"><strong><span data-key="difficulty_label"></span>:</strong> <span id="guest-game-difficulty"></span></div> </div> <br> <p data-key="waiting_msg"></p> </div> 
        <div id="share-controls"><button id="share-btn" class="btn btn-secondary" data-key="share_btn"></button></div>
        <button class="back-btn" id="leave-lobby-btn">← <span data-key="leave_lobby_btn"></span></button> </div></div> </section>
        <section id="game-screen" class="game-screen"> <div class="container"><div class="game-card"> <div class="game-header"> <span id="question-counter"></span> <span id="main-timer"></span> </div> <div id="progress-bar-container"><div id="progress-bar"></div></div> <div id="question-container"></div> <div id="answer-options" class="answer-options"></div> </div></div> </section>
        <section id="results-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="results_title"></h1><h3 id="results-room-code"></h3><h2 id="results-subtitle" data-key="final_scores"></h2><table id="results-table"><thead><tr><th data-key="rank_header"></th><th data-key="name_header"></th><th data-key="score_header"></th></tr></thead><tbody id="results-body"></tbody></table> <div id="answer-key-container"></div> <button id="answer-key-btn" class="btn btn-secondary" data-key="show_answers_btn"></button> <button id="download-report-btn" class="btn" data-key="download_report_btn"></button> <button id="play-again-btn" class="btn" data-key="play_again_btn"></button></div></div> </section>
    </main>
    <footer> <div class="container" data-key="footer_text"></div> </footer>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
    const firebaseConfig = {
      apiKey: "AIzaSyAYurYfkcGSbRmLNBtXmX60iml5ty8-ipI",
      authDomain: "sbg-math-game.firebaseapp.com",
      databaseURL: "https://sbg-math-game-default-rtdb.firebaseio.com",
      projectId: "sbg-math-game",
      storageBucket: "sbg-math-game.firebasestorage.app",
      messagingSenderId: "520015027553",
      appId: "1:520015027553:web:17c396b24da3fa6e8f3920",
      measurementId: "G-S9KFTEQZ9P"
    };
    firebase.initializeApp(firebaseConfig);

    
    // --- App State and DOM Elements ---
    let appInitialized = false;
    let db;
    const translations = {
        or: { lang_btn: "ଓଡ଼ିଆ", logo_text: "SB ଗଣିତ ବିଜ୍ଞ ଗେମ୍ ରୁମ୍", home_btn: "ହୋମ୍", other_games_btn: "ଗଣିତ ବିଜ୍ଞ", welcome: "ଗଣିତ ବିଜ୍ଞ ଦଳ କୁ ସ୍ଵାଗତ!", create_room_btn: "ରୁମ୍ ତିଆରି କରନ୍ତୁ", join_room_btn: "ରୁମ୍ ରେ ଯୋଗ ଦିଅନ୍ତୁ", check_results_btn: "ଫଳାଫଳ ଦେଖନ୍ତୁ", create_title: "ଏକ ଗେମ୍ ରୁମ୍ ତିଆରି କରନ୍ତୁ", room_code_label: "ରୁମ୍ କୋଡ୍", name_label: "ଆପଣଙ୍କ ନାମ", password_label: "ରୁମ୍ ପାସୱାର୍ଡ (ବୈକଳ୍ପିକ)", create_btn: "ତିଆରି କରି ଲବିରେ ପ୍ରବେଶ କରନ୍ତୁ", back_btn: "ପଛକୁ", join_title: "ଏକ ଗେମ୍ ରୁମ୍ ରେ ଯୋଗ ଦିଅନ୍ତୁ", join_btn: "ଲବିରେ ଯୋଗ ଦିଅନ୍ତୁ", lobby_title: "ଲବି", room_code_display: "ରୁମ୍ କୋଡ୍:", players_in_room: "ଖେଳାଳି:", game_settings_title: "ଗେମ୍ ସେଟିଂସ୍", total_time_label: "ମୋଟ ସମୟ", q_count_label: "ପ୍ରଶ୍ନ ସଂଖ୍ୟା", game_type_label: "ଗେମ୍ ପ୍ରକାର", difficulty_label: "କଠିନତା", type_mix: "ମିଶ୍ରଣ", type_add: "ମିଶାଣ", type_sub: "ଫେଡାଣ", type_mul: "ଗୁଣନ", type_div: "ହରଣ", diff_easy: "ସହଜ", diff_medium: "ମଧ୍ୟମ", diff_hard: "କଠିନ", start_game_btn: "ଗେମ୍ ଆରମ୍ଭ କରନ୍ତୁ", start_game_info: "ଆରମ୍ଭ ପାଇଁ ସର୍ବନିମ୍ନ ୨ ଖେଳାଳି ଆବଶ୍ୟକ", waiting_msg: "ହୋଷ୍ଟ୍ ଗେମ୍ ଆରମ୍ଭ କରିବାକୁ ଅପେକ୍ଷା କରନ୍ତୁ...", leave_lobby_btn: "ଲବି ଛାଡନ୍ତୁ", question: "ପ୍ରଶ୍ନ", results_title: "ଗେମ୍ ସମାପ୍ତ!", final_scores: "ଅନ୍ତିମ ସ୍କୋର୍", waiting_for_others: "ଅନ୍ୟ ଖେଳାଳିଙ୍କ ପାଇଁ ଅପେକ୍ଷା କରୁଛି...", show_answers_btn: "ଉତ୍ତର ଦେଖନ୍ତୁ", answer_key: "ଉତ୍ତର ସୂଚୀ", correct_answer: "ସଠିକ୍ ଉତ୍ତର", your_answer: "ଆପଣଙ୍କ ଉତ୍ତର", correct: "ସଠିକ୍", incorrect: "ଭୁଲ", unanswered: "ଉତ୍ତର ଦିଆଯାଇନାହିଁ", rank_header: "ରାଙ୍କ୍", name_header: "ନାମ", score_header: "ସ୍କୋର୍", play_again_btn: "ପୁଣି ଖେଳନ୍ତୁ", footer_text: "❤️ ସହିତ <a href='https://www.instagram.com/sandeepbiswalg' target='_blank' rel='noopener noreferrer'>ସନ୍ଦୀପ ବିଶ୍ଵାଳ G </a>ଙ୍କ ଦ୍ଵାରା ସୁନ୍ଦର ସୁନ୍ଦର ପିଲାମାନଙ୍କ ପାଇଁ  ପ୍ରସ୍ତୁତ", time_up_msg: "ସମୟ ସମାପ୍ତ!", room_deleted_msg: "ରୁମ୍ ହୋଷ୍ଟ୍ ଦ୍ଵାରା ଡିଲିଟ୍ ହୋଇଯାଇଛି |", you_msg: "ଆପଣ", minute_msg: "ମିନିଟ୍", download_report_btn: "ରିପୋର୍ଟ ଡାଉନଲୋଡ୍ କରନ୍ତୁ", room_code_error: "ଦୟାକରି ଏକ ୪-ଅଙ୍କ ବିଶିଷ୍ଟ କୋଡ୍ ଦିଅନ୍ତୁ |", general_error: "ଆପଣଙ୍କ ନାମ ଆବଶ୍ୟକ |", room_exists_error: "This room code already exists.", room_not_found_error: "ରୁମ୍ ମିଳିଲା ନାହିଁ |", room_full_error: "ରୁମ୍ ପୂର୍ଣ୍ଣ ଅଛି |", name_in_use_error: "ଏହି ନାମ ପୂର୍ବରୁ ବ୍ୟବହୃତ ହୋଇଛି |", password_error: "ଭୁଲ୍ ପାସୱାର୍ଡ |", share_btn: "ସାଙ୍ଗମାନଙ୍କୁ ନିମନ୍ତ୍ରଣ କରନ୍ତୁ", invite_copied: "ନିମନ୍ତ୍ରଣ ଲିଙ୍କ୍ କପି ହୋଇଗଲା!", you_were_kicked_msg: "ଆପଣଙ୍କୁ ହୋଷ୍ଟ୍ ଦ୍ଵାରା ରୁମ୍ ରୁ ବାହାର କରିଦିଆଯାଇଛି |" },
        en: { lang_btn: "English", logo_text: "SB Math wiz Game Room", home_btn: "Home", other_games_btn: "Math Wizard", welcome: "Welcome! to Math wizard team", create_room_btn: "Create Room", join_room_btn: "Join Room", check_results_btn: "Check Results", create_title: "Create a Game Room", room_code_label: "Room Code", name_label: "Your Name", password_label: "Room Password (Optional)", create_btn: "Create & Enter Lobby", back_btn: "Back", join_title: "Join a Game Room", join_btn: "Join Lobby", lobby_title: "Lobby", room_code_display: "Room Code:", players_in_room: "Players:", game_settings_title: "Game Settings", total_time_label: "Total Time", q_count_label: "No. of Questions", game_type_label: "Game Type", difficulty_label: "Difficulty", type_mix: "Mix", type_add: "Addition", type_sub: "Subtraction", type_mul: "Multiplication", type_div: "Division", diff_easy: "Easy", diff_medium: "Medium", diff_hard: "Hard", start_game_btn: "Start Game", start_game_info: "Minimum 2 players to start", waiting_msg: "Waiting for the host to start...", leave_lobby_btn: "Leave Lobby", question: "Question", results_title: "Game Over!", final_scores: "Final Scores", waiting_for_others: "Waiting for other players to finish...", show_answers_btn: "Show Answers", answer_key: "Answer Key", correct_answer: "Correct Answer", your_answer: "Your Answer", correct: "Correct", incorrect: "Incorrect", unanswered: "Unanswered", rank_header: "Rank", name_header: "Name", score_header: "Score", play_again_btn: "Play Again", footer_text: "Made with ❤️ by <a href='https://www.instagram.com/sandeepbiswalg' target='_blank' rel='noopener noreferrer'>Sandeep Biswal G</a> for cute cute childs", time_up_msg: "Time's Up!", room_deleted_msg: "Room was deleted by host.", you_msg: "You", minute_msg: "Minutes", download_report_btn: "Download Report", room_code_error: "Please enter a 4-digit room code.", general_error: "Your name is required.", room_exists_error: "This room code already exists.", room_not_found_error: "Room not found.", room_full_error: "Room is full.", name_in_use_error: "This name is already in use.", password_error: "Incorrect password.", share_btn: "Invite Friends", invite_copied: "Invite link copied!", you_were_kicked_msg: "You have been removed from the room by the host." }
    };
    const PLAYER_LIMIT = 100;
    let gameState = { roomCode: null, playerName: null, isHost: false, lobbyListener: null, resultsListener: null, questions: [], mainGameTimer: null };
    let gameLogicState = { currentQuestionIndex: -1, score: 0, playerAnswers: [] };
    const dom = {}; 
    ['lang-or', 'lang-en', 'show-create-btn', 'show-join-btn', 'create-player-name', 'create-password', 'create-btn', 'create-error', 'join-room-code-num', 'join-player-name', 'join-password', 'join-btn', 'join-error', 'lobby-room-code', 'player-list', 'host-controls', 'guest-info', 'start-game-btn', 'start-game-info', 'leave-lobby-btn', 'game-timer', 'question-count', 'game-type', 'game-difficulty', 'guest-game-timer', 'guest-question-count', 'guest-game-type', 'guest-game-difficulty', 'play-again-btn', 'progress-bar', 'question-counter', 'question-container', 'answer-options', 'main-timer', 'results-body', 'results-subtitle', 'answer-key-btn', 'answer-key-container', 'download-report-btn', 'results-room-code', 'share-btn'].forEach(id => dom[id.replace(/-/g, '_')] = document.getElementById(id));
    dom.screens = document.querySelectorAll('.game-screen');

    // --- Core Functions ---
    const toOdiaNumerals = s => String(s).replace(/[0-9]/g, d => '୦୧୨୩୪୫୬୭୮୯'[d]);
    const displayNum = n => document.documentElement.lang === 'or' ? toOdiaNumerals(n) : String(n);
    const getRoomRef = (rc) => db.ref('rooms/' + rc);
    const getRoomData = async (rc) => { const snapshot = await getRoomRef(rc).get(); return snapshot.exists() ? snapshot.val() : null; };
    const updateRoomData = (rc, updates) => getRoomRef(rc).update(updates);
    const deleteRoom = (rc) => getRoomRef(rc).remove();
    const seededRandom = seed => { let s = seed.split('').reduce((a, b) => (a = (a << 5) - a + b.charCodeAt(0), a & a), 0); return () => (s = Math.imul(s ^ s >>> 15, s | 1), s ^= s + Math.imul(s ^ s >>> 7, s | 61), ((s ^ s >>> 14) >>> 0) / 4294967296); };
    
    // --- Screen and URL Management ---
    const showScreen = (screenId, updateUrl = true) => { dom.screens.forEach(s => s.classList.remove('active')); const screenEl = document.getElementById(screenId); if (screenEl) screenEl.classList.add('active'); if (updateUrl) updateURL(screenId); };
    const updateURL = (screen) => { let hash = ''; switch(screen) { case 'create-screen': hash = 'croom'; break; case 'join-screen': hash = 'jroom'; break; case 'lobby-screen': hash = `lobby/${gameState.roomCode}`; break; case 'game-screen': hash = `game/${gameState.roomCode}`; break; case 'results-screen': hash = `results/${gameState.roomCode}`; break; default: hash = ''; break; } const currentHash = window.location.hash.replace('#', ''); if (hash !== currentHash) { history.pushState({ screen: hash }, '', `#${hash}`); } };
    
    // --- Language Management ---
    function setLanguage(lang) { document.documentElement.lang = lang; document.body.className = `${lang}-lang`; document.querySelectorAll('[data-key]').forEach(el => { const t = translations[lang]?.[el.dataset.key]; if (t) el.innerHTML = t; }); dom.lang_or.textContent = translations.or.lang_btn; dom.lang_en.textContent = translations.en.lang_btn; dom.lang_or.classList.toggle('active', lang === 'or'); dom.lang_en.classList.toggle('active', lang === 'en'); localStorage.setItem('preferredLang', lang); const url = new URL(window.location); url.searchParams.set('lang', lang); history.replaceState({}, '', url); populateSelects(lang); }
    function populateSelects(lang) { const timeOptions = {60:1, 120:2, 300:5, 600:10, 900:15, 1200:20, 1800:30}; dom.game_timer.innerHTML = Object.entries(timeOptions).map(([sec, min]) => `<option value="${sec}">${displayNum(min)} ${translations[lang].minute_msg}</option>`).join(''); const qCountOptions = [10, 15, 20, 30, 50, 60, 80, 100]; dom.question_count.innerHTML = qCountOptions.map(c => `<option value="${c}">${displayNum(c)}</option>`).join(''); const typeKeys = ['mix', 'add', 'sub', 'mul', 'div']; dom.game_type.innerHTML = typeKeys.map(k => `<option value="${k}">${translations[lang]['type_'+k]}</option>`).join(''); const diffKeys = ['easy', 'medium', 'hard']; dom.game_difficulty.innerHTML = diffKeys.map(k => `<option value="${k}">${translations[lang]['diff_'+k]}</option>`).join(''); }
    function generateMathQuestions(seed, type, difficulty, count) { const r = seededRandom(seed); const ops = type === 'mix' ? ['+', '-', '*', '/'] : {add:['+'], sub:['-'], mul:['*'], div:['/']}[type]; const ranges = { easy: [10, 50, 10, 10], medium: [50, 100, 25, 15], hard: [500, 1000, 50, 30] }; const [addMax, subMax, mulMax, divMax] = ranges[difficulty]; return Array.from({ length: count }, () => { const op = ops[Math.floor(r() * ops.length)]; let n1, n2, q, a; switch (op) { case '+': n1 = Math.floor(r() * addMax) + 1; n2 = Math.floor(r() * addMax) + 1; q = `${n1} + ${n2}`; a = n1 + n2; break; case '-': n1 = Math.floor(r() * subMax) + addMax; n2 = Math.floor(r() * (n1 - 1)) + 1; q = `${n1} - ${n2}`; a = n1 - n2; break; case '*': n1 = Math.floor(r() * mulMax) + 2; n2 = Math.floor(r() * mulMax) + 2; q = `${n1} × ${n2}`; a = n1 * n2; break; case '/': const d = Math.floor(r() * divMax) + 2, rs = Math.floor(r() * divMax) + 2; n1 = d * rs; n2 = d; q = `${n1} ÷ ${n2}`; a = rs; break; } const opts = new Set([a]); while (opts.size < 4) { const w = a + (Math.floor(r() * 20) + 1) * (r() > 0.5 ? 1 : -1); if (w !== a && w >= 0) opts.add(w); } return { question: q, options: Array.from(opts).sort(() => r() - 0.5), answer: a }; }); }
    
    // --- Game Flow and State Management ---
    function enterLobby(roomCode, playerName, isHost) {
        sessionStorage.setItem('sbg_roomCode', roomCode);
        sessionStorage.setItem('sbg_playerName', playerName);
        gameState = { ...gameState, roomCode, playerName, isHost };

        const playerRef = db.ref(`rooms/${roomCode}/players/${playerName}`);
        playerRef.onDisconnect().remove(); // If player disconnects, remove them
        if (isHost) {
            getRoomRef(roomCode).onDisconnect().remove(); // If host disconnects, remove the room
        }

        dom.host_controls.style.display = isHost ? 'block' : 'none';
        dom.guest_info.style.display = isHost ? 'none' : 'block';
        dom.lobby_room_code.textContent = roomCode;
        showScreen('lobby-screen');
        startLobbyListener();
    }

    function startLobbyListener() {
        if (gameState.lobbyListener) getRoomRef(gameState.roomCode).off('value', gameState.lobbyListener);
        gameState.lobbyListener = (snapshot) => {
            const roomData = snapshot.val();
            if (!roomData) {
                leaveLobby(translations[document.documentElement.lang].room_deleted_msg, true);
                return;
            }
            if (!roomData.players || !roomData.players[gameState.playerName]) {
                leaveLobby(translations[document.documentElement.lang].you_were_kicked_msg, true);
                return;
            }
            const lang = document.documentElement.lang;
            const players = roomData.players ? Object.values(roomData.players) : [];
            dom.player_list.innerHTML = players.map(p => `<li>
                <span>${p.name}${p.name === gameState.playerName ? ` (${translations[lang].you_msg})` : ''}${p.isHost ? ' 👑' : ''}</span>
                ${(gameState.isHost && p.name !== gameState.playerName) ? `<button class="remove-player-btn" data-player-name="${p.name}" title="Remove player">×</button>` : ''}
            </li>`).join('');

            if (gameState.isHost) {
                const canStart = players.length >= 2;
                dom.start_game_btn.disabled = !canStart;
                dom.start_game_info.style.display = canStart ? 'none' : 'block';
            } else {
                const { settings } = roomData;
                dom.guest_game_timer.textContent = `${displayNum(settings.timer / 60)} ${translations[lang].minute_msg}`;
                dom.guest_question_count.textContent = displayNum(settings.q_count);
                dom.guest_game_type.textContent = translations[lang][`type_${settings.type}`];
                dom.guest_game_difficulty.textContent = translations[lang][`diff_${settings.difficulty}`];
            }
            if (roomData.status === 'started') {
                getRoomRef(gameState.roomCode).off('value', gameState.lobbyListener);
                gameState.lobbyListener = null;
                gameState.questions = roomData.questions;
                startGame(roomData);
            }
        };
        getRoomRef(gameState.roomCode).on('value', gameState.lobbyListener);
    }

    function cleanUpSession() {
        if (gameState.lobbyListener) getRoomRef(gameState.roomCode).off('value', gameState.lobbyListener);
        if (gameState.resultsListener) getRoomRef(gameState.roomCode).off('value', gameState.resultsListener);
        clearInterval(gameState.mainGameTimer);
        sessionStorage.removeItem('sbg_roomCode');
        sessionStorage.removeItem('sbg_playerName');
        gameState = { roomCode: null, playerName: null, isHost: false, lobbyListener: null, resultsListener: null, questions: [], mainGameTimer: null };
        gameLogicState = { currentQuestionIndex: -1, score: 0, playerAnswers: [] };
    }

    async function leaveLobby(reason = "", isKicked = false) {
        const roomCode = gameState.roomCode;
        const playerName = gameState.playerName;
        if (roomCode && playerName && !isKicked) {
            const playerRef = db.ref(`rooms/${roomCode}/players/${playerName}`);
            await playerRef.onDisconnect().cancel(); // Cancel pending hook on clean exit
            await playerRef.remove();
            if (gameState.isHost) {
                await getRoomRef(roomCode).onDisconnect().cancel(); // Cancel room deletion hook
                await deleteRoom(roomCode);
            }
        }
        cleanUpSession();
        if (reason) alert(reason);
        showScreen('landing-screen');
    }

    function startGame(roomData) { gameLogicState = { currentQuestionIndex: -1, score: 0, playerAnswers: [] }; showScreen('game-screen'); startMainTimer(roomData); displayNextQuestion(); }
    async function startMainTimer(roomData) { if (gameState.mainGameTimer) clearInterval(gameState.mainGameTimer); const serverTimeOffsetSnapshot = await db.ref('/.info/serverTimeOffset').once('value'); const serverTimeOffset = serverTimeOffsetSnapshot.val() || 0; if (typeof roomData.gameStartedAt !== 'number') { console.error("Game start time not found or invalid!"); dom.main_timer.textContent = '...'; return; } const estimatedServerTimeNow = new Date().getTime() + serverTimeOffset; const elapsedTime = Math.floor((estimatedServerTimeNow - roomData.gameStartedAt) / 1000); let timeLeft = roomData.settings.timer - elapsedTime; if (timeLeft < 0) timeLeft = 0; const update = () => dom.main_timer.textContent = `${displayNum(Math.floor(timeLeft/60))}:${displayNum((timeLeft%60).toString().padStart(2,'0'))}`; update(); gameState.mainGameTimer = setInterval(() => { if (--timeLeft < 0) { forceEndGame(true); } else update(); }, 1000); }
    async function displayNextQuestion() { gameLogicState.currentQuestionIndex++; const roomData = await getRoomData(gameState.roomCode); if (!roomData || gameLogicState.currentQuestionIndex >= roomData.settings.q_count) { forceEndGame(false); return; } const q = gameState.questions[gameLogicState.currentQuestionIndex]; dom.progress_bar.style.width = `${((gameLogicState.currentQuestionIndex + 1) / roomData.settings.q_count) * 100}%`; dom.question_counter.textContent = `${translations[document.documentElement.lang].question} ${displayNum(gameLogicState.currentQuestionIndex + 1)}/${displayNum(roomData.settings.q_count)}`; const qText = q.question.split(' ').map(part => isNaN(part) ? part : displayNum(part)).join(' '); dom.question_container.textContent = `${qText} = ?`; dom.answer_options.innerHTML = q.options.map(o => `<button class="btn answer-btn">${displayNum(o)}</button>`).join(''); dom.answer_options.querySelectorAll('.answer-btn').forEach(b => b.onclick = () => handleAnswer(parseInt(b.innerText.replace(/[୦-୯]/g, d => '୦୧୨୩୪୫୬୭୮୯'.indexOf(d))))); }
    
    function handleAnswer(selected) {
        const q = gameState.questions[gameLogicState.currentQuestionIndex];
        if (selected === q.answer) gameLogicState.score++;
        gameLogicState.playerAnswers.push({ qIndex: gameLogicState.currentQuestionIndex, question: q.question, answer: selected, correctAnswer: q.answer });
        dom.answer_options.querySelectorAll('.answer-btn').forEach(btn => {
            btn.disabled = true;
            const val = parseInt(btn.innerText.replace(/[୦-୯]/g, d => '୦୧୨୩୪୫୬୭୮୯'.indexOf(d)));
            if (val === q.answer) btn.classList.add('correct');
            else if (val === selected) btn.classList.add('incorrect');
        });
        setTimeout(displayNextQuestion, 400); // Faster transition
    }

    async function forceEndGame(isTimeUp) {
        clearInterval(gameState.mainGameTimer);
        if(isTimeUp) alert(translations[document.documentElement.lang].time_up_msg);
        const roomData = await getRoomData(gameState.roomCode);
        if (roomData) {
            for (let i = gameLogicState.currentQuestionIndex; i < roomData.settings.q_count; i++) { if (gameState.questions && i < gameState.questions.length && !gameLogicState.playerAnswers.find(a => a.qIndex === i)) { gameLogicState.playerAnswers.push({ qIndex: i, question: gameState.questions[i].question, answer: null, correctAnswer: gameState.questions[i].answer }); } }
            const myResult = { name: gameState.playerName, score: gameLogicState.score, answers: gameLogicState.playerAnswers };
            await updateRoomData(gameState.roomCode, { [`results/${gameState.playerName}`]: myResult });
            const updatedRoomData = await getRoomData(gameState.roomCode);
            // Check if all *active* players have finished
            if(updatedRoomData && updatedRoomData.players && updatedRoomData.results){
                const numPlayers = Object.keys(updatedRoomData.players).length;
                const numResults = Object.keys(updatedRoomData.results).length;
                if (numResults >= numPlayers) {
                    await updateRoomData(gameState.roomCode, { status: 'finished' });
                }
            }
        }
        showScreen('results-screen');
        dom.results_subtitle.setAttribute('data-key', 'waiting_for_others');
        setLanguage(document.documentElement.lang);
        dom.results_body.innerHTML = '';
        startResultsListener();
    }
    
    function startResultsListener() { if (gameState.resultsListener) getRoomRef(gameState.roomCode).off('value', gameState.resultsListener); gameState.resultsListener = (snapshot) => { const finalRoomData = snapshot.val(); if(finalRoomData && finalRoomData.status === 'finished') { getRoomRef(gameState.roomCode).off('value', gameState.resultsListener); gameState.resultsListener = null; dom.results_room_code.textContent = `Room: ${gameState.roomCode}`; dom.results_subtitle.setAttribute('data-key', 'final_scores'); setLanguage(document.documentElement.lang); const results = Object.values(finalRoomData.results); dom.results_body.innerHTML = results.sort((a,b) => b.score - a.score).map((r, i) => `<tr><td>${displayNum(i+1)}</td><td>${r.name}</td><td>${displayNum(r.score)}/${displayNum(finalRoomData.settings.q_count)}</td></tr>`).join(''); } }; getRoomRef(gameState.roomCode).on('value', gameState.resultsListener); }
    
    // --- Event Listeners ---
    dom.show_create_btn.onclick = () => showScreen('create-screen');
    dom.show_join_btn.onclick = () => showScreen('join-screen');
    document.querySelectorAll('.back-btn, .home-link').forEach(btn => btn.onclick = (e) => { e.preventDefault(); leaveLobby(); });
    dom.leave_lobby_btn.onclick = () => leaveLobby();
    async function generateUniqueRoomCode() { let roomCode = ''; let roomExists = true; while(roomExists) { const randomNum = Math.floor(1000 + Math.random() * 9000).toString(); roomCode = `SB${randomNum}`; const data = await getRoomData(roomCode); roomExists = data !== null; } return roomCode; }
    dom.create_btn.onclick = async () => { const pn = dom.create_player_name.value.trim(); const pw = dom.create_password.value.trim(); const lang = document.documentElement.lang; dom.create_error.textContent = ''; if (!pn) { dom.create_error.textContent = translations[lang].general_error; return; } const rc = await generateUniqueRoomCode(); const settings = { timer: 60, q_count: 10, type: 'mix', difficulty: 'easy' }; await getRoomRef(rc).set({ password: pw || null, players: { [pn]: { name: pn, isHost: true } }, status: 'lobby', settings, createdAt: firebase.database.ServerValue.TIMESTAMP }); enterLobby(rc, pn, true); };
    dom.join_btn.onclick = async () => { const rcNum = dom.join_room_code_num.value.trim(); const pn = dom.join_player_name.value.trim(); const pw = dom.join_password.value.trim(); const lang = document.documentElement.lang; dom.join_error.textContent = ''; if (rcNum.length !== 4 || !/^\d{4}$/.test(rcNum)) { dom.join_error.textContent = translations[lang].room_code_error; return; } if (!pn) { dom.join_error.textContent = translations[lang].general_error; return; } const rc = `SB${rcNum}`; const rd = await getRoomData(rc); if (!rd) { dom.join_error.textContent = translations[lang].room_not_found_error; return; } if (rd.players && Object.keys(rd.players).length >= PLAYER_LIMIT) { dom.join_error.textContent = translations[lang].room_full_error; return; } if (rd.players && rd.players[pn]) { dom.join_error.textContent = translations[lang].name_in_use_error; return; } if (rd.password && rd.password !== pw) { dom.join_error.textContent = translations[lang].password_error; return; } await updateRoomData(rc, { [`players/${pn}`]: { name: pn, isHost: false } }); enterLobby(rc, pn, false); };
    dom.start_game_btn.onclick = async () => { const rd = await getRoomData(gameState.roomCode); if (rd) { const newQuestions = generateMathQuestions(gameState.roomCode, rd.settings.type, rd.settings.difficulty, rd.settings.q_count); await updateRoomData(gameState.roomCode, { status: 'started', questions: newQuestions, gameStartedAt: firebase.database.ServerValue.TIMESTAMP }); } };
    ['game-timer', 'question-count', 'game-type', 'game-difficulty'].forEach(elId => { dom[elId.replace('-', '_')].onchange = (e) => { if (gameState.isHost) { const key = e.target.id.includes('timer') ? 'timer' : (e.target.id.includes('count') ? 'q_count' : e.target.id.split('-')[1]); updateRoomData(gameState.roomCode, { [`settings/${key}`]: e.target.value }); } }; });
    [dom.create_password, dom.join_password, dom.join_room_code_num].forEach(el => el.addEventListener('input', e => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); }));
    dom.play_again_btn.onclick = () => { dom.answer_key_container.style.display = 'none'; cleanUpSession(); showScreen('landing-screen'); };
    function generateAndDownloadReport(roomCode, roomData) { if (!roomData) return; let reportContent = `GAME REPORT FOR ROOM: ${roomCode}\n========================================\n\n--- Room Details ---\nStatus: ${roomData.status}\nPassword: ${roomData.password || 'None'}\nCreated At: ${new Date(roomData.createdAt).toLocaleString()}\n\n--- Game Settings ---\nTotal Time: ${roomData.settings.timer / 60} minutes\nNumber of Questions: ${roomData.settings.q_count}\nGame Type: ${roomData.settings.type}\nDifficulty: ${roomData.settings.difficulty}\n\n`; if (roomData.questions) { reportContent += `--- Question & Answer Key ---\n`; roomData.questions.forEach((q, i) => { reportContent += `Q${i + 1}: ${q.question} = ${q.answer}\n`; }); reportContent += `\n`; } if (roomData.status === 'finished' && roomData.results) { reportContent += `--- Final Results & Player Answers ---\n`; const sortedResults = Object.values(roomData.results).sort((a, b) => b.score - a.score); sortedResults.forEach((player, i) => { reportContent += `\n#${i + 1} | Player: ${player.name} | Score: ${player.score}/${roomData.settings.q_count}\n`; if (player.answers) { player.answers.forEach(ans => { const status = ans.answer === ans.correctAnswer ? "Correct" : (ans.answer === null ? "Unanswered" : "Incorrect"); reportContent += `  Q${ans.qIndex + 1} (${ans.question}): You answered: ${ans.answer === null ? 'N/A' : ans.answer}. Correct was: ${ans.correctAnswer}. [${status}]\n`; }); } }); } const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${roomCode}_Report.txt`; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    dom.download_report_btn.onclick = async () => { const roomData = await getRoomData(gameState.roomCode); generateAndDownloadReport(gameState.roomCode, roomData); };
    dom.answer_key_btn.onclick = async () => { const lang = document.documentElement.lang; const roomData = await getRoomData(gameState.roomCode); if (!roomData || !roomData.results) return; const myResult = roomData.results[gameState.playerName]; if (!myResult) return; const questions = roomData.questions; let keyHTML = `<h3 data-key="answer_key">${translations[lang].answer_key}</h3><table>`; questions.forEach((q, i) => { const playerAnswerObj = myResult.answers.find(a => a.qIndex === i); let answerText; if (!playerAnswerObj || playerAnswerObj.answer === null) { answerText = `<span class="wrong-ans">${translations[lang].unanswered}</span>`; } else if (playerAnswerObj.answer === q.answer) { answerText = `<span class="correct-ans">${translations[lang].correct}</span>`; } else { answerText = `<span class="wrong-ans">${translations[lang].incorrect}</span> (${translations[lang].your_answer}: ${displayNum(playerAnswerObj.answer)})`; } const qText = q.question.split(' ').map(p => isNaN(p) ? p : displayNum(p)).join(' '); keyHTML += `<tr><td>${displayNum(i+1)}. ${qText} = ${displayNum(q.answer)}</td><td>${answerText}</td></tr>`; }); keyHTML += '</table>'; dom.answer_key_container.innerHTML = keyHTML; dom.answer_key_container.style.display = dom.answer_key_container.style.display === 'block' ? 'none' : 'block'; };
    dom.lang_or.onclick = () => setLanguage('or');
    dom.lang_en.onclick = () => setLanguage('en');
    dom.share_btn.onclick = () => { const url = new URL(window.location); url.hash = `join/${gameState.roomCode}`; navigator.clipboard.writeText(url.toString()).then(() => { alert(translations[document.documentElement.lang].invite_copied); }); };
    
    // Listener for removing players (event delegation)
    dom.player_list.addEventListener('click', (e) => {
        if (e.target && e.target.classList.contains('remove-player-btn')) {
            const playerNameToRemove = e.target.dataset.playerName;
            if (playerNameToRemove && gameState.isHost) {
                if (confirm(`Are you sure you want to remove ${playerNameToRemove}?`)) {
                    db.ref(`rooms/${gameState.roomCode}/players/${playerNameToRemove}`).remove();
                }
            }
        }
    });

    // --- Initialization and Routing ---
    async function handleRouting() {
        if (!appInitialized) return;
        const hash = window.location.hash.replace('#', '');
        const [screen, param] = hash.split('/');
        
        const playerNameFromSession = sessionStorage.getItem('sbg_playerName');
        const roomCodeFromSession = sessionStorage.getItem('sbg_roomCode');

        if (param && playerNameFromSession && param === roomCodeFromSession) {
            const roomData = await getRoomData(param);
            if (roomData && roomData.players && roomData.players[playerNameFromSession]) {
                gameState.roomCode = param;
                gameState.playerName = playerNameFromSession;
                gameState.isHost = roomData.players[playerNameFromSession].isHost;
                gameState.questions = roomData.questions || [];
                if (roomData.status === 'lobby' && screen === 'lobby') { enterLobby(param, playerNameFromSession, gameState.isHost); return; }
                if (roomData.status === 'started' && screen === 'game') { startGame(roomData); return; }
                if (roomData.status === 'finished' && screen === 'results') { showScreen('results-screen', false); startResultsListener(); return; }
            }
        }
        
        cleanUpSession();
        if (screen === 'croom') { showScreen('create-screen', false); } 
        else if (screen === 'jroom') { showScreen('join-screen', false); }
        else if (screen === 'join' && param) { dom.join_room_code_num.value = param.replace('SB', ''); showScreen('join-screen', false); }
        else { showScreen('landing-screen'); }
    }

    function init() {
        try {
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_")) {
                document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red; font-size: 1.2rem;"><h1>Configuration Error</h1><p>Firebase keys are missing. Please paste your firebaseConfig object into index.html.</p></div>`;
                return;
            }
            db = firebase.database();
            db.ref(".info/connected").on("value", (snap) => {
                if (snap.val() === true && !appInitialized) {
                    appInitialized = true;
                    const urlParams = new URLSearchParams(window.location.search);
                    const langFromUrl = urlParams.get('lang');
                    const langFromStorage = localStorage.getItem('preferredLang');
                    setLanguage(langFromUrl || langFromStorage || 'or');
                    handleRouting();
                    window.addEventListener('popstate', handleRouting);
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red; font-size: 1.2rem;"><h1>Initialization Error</h1><p>Could not connect to Firebase. Please check your config keys and console for errors.</p></div>`;
        }
    }

    init();
});
</script>

</body>
</html>
