<!DOCTYPE html>
<html lang="or">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta name="theme-color" content="#0a2463"/>
    <title>‡¨ó‡¨£‡¨ø‡¨§ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û ‡¨∞‡≠Å‡¨Æ‡≠ç | Math Wizard Room</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/imsbg/odiagames/refs/heads/main/icon/ml.png">

    <!-- SEO Meta Tags -->
    <meta name="description" content="‡¨ì‡¨°‡¨º‡¨ø‡¨Ü‡¨∞‡≠á ‡¨ó‡¨£‡¨ø‡¨§ ‡¨ó‡≠á‡¨Æ‡≠ç ‡¨ñ‡≠á‡¨≥‡¨®‡≠ç‡¨§‡≠Å | Create or join a live game room and play math games with friends in Odia. Fun, free, and educational.">
    <meta name="keywords" content="Odia game, Odia math game, math game, online game, multiplayer game, educational game, ‡¨ì‡¨°‡¨º‡¨ø‡¨Ü ‡¨ó‡≠á‡¨Æ‡≠ç, ‡¨ó‡¨£‡¨ø‡¨§ ‡¨ó‡≠á‡¨Æ‡≠ç, ‡¨ó‡¨£‡¨ø‡¨§ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û, ‡¨ó‡¨£‡¨ø‡¨§ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û Room, Math Wizard, Math Wizard Room, Math Wizard Game Room, Live Math Game, Online Math Game">
    <meta name="author" content="Sandeep Biswal G">
    <link rel="canonical" href="https://odiagames.site/‡¨ó‡¨£‡¨ø‡¨§%20‡¨¨‡¨ø‡¨ú‡≠ç‡¨û/live/" /> <!-- Replace with your actual URL -->

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://odiagames.site/‡¨ó‡¨£‡¨ø‡¨§%20‡¨¨‡¨ø‡¨ú‡≠ç‡¨û/live/">
    <meta property="og:title" content="‡¨ó‡¨£‡¨ø‡¨§ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û ‡¨∞‡≠Å‡¨Æ‡≠ç | Math Wizard Room">
    <meta property="og:description" content="Create or join a game room and play live math games with friends in Odia.">
    <meta property="og:image" content="https://raw.githubusercontent.com/imsbg/odiagames/refs/heads/main/icon/ml.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://odiagames.site/‡¨ó‡¨£‡¨ø‡¨§%20‡¨¨‡¨ø‡¨ú‡≠ç‡¨û/live/">
    <meta property="twitter:title" content="‡¨ó‡¨£‡¨ø‡¨§ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û ‡¨∞‡≠Å‡¨Æ‡≠ç | Math Wizard Room">
    <meta property="twitter:description" content="Create or join a game room and play live math games with friends in Odia.">
    <meta property="twitter:image" content="https://raw.githubusercontent.com/imsbg/odiagames/refs/heads/main/icon/ml.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Oriya:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0A2463; --secondary-color: #3E92CC; --accent-color: #FF9F1C; --success-color: #28a745; --danger-color: #dc3545; --text-light: #FFFFFF; --text-dark: #121212; --bg-light: #F4F7FC; --card-bg: #FFFFFF; --shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--bg-light); color: var(--text-dark); line-height: 1.6; font-family: 'Poppins', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        body.or-lang { font-family: 'Noto Sans Oriya', 'Poppins', sans-serif; }
        .container { max-width: 650px; margin: 0 auto; padding: 0 20px; }
        
        /* --- Header & New Mobile Menu --- */
        header { background-color: var(--primary-color); color: var(--text-light); padding: 1rem 0; position: sticky; top: 0; z-index: 1000; }
        header .container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.2rem; font-weight: 700; color: var(--text-light); text-decoration: none; }
        .nav-wrapper { display: flex; align-items: center; gap: 1rem; }
        .ping-display { font-size: 0.9rem; color: #a9c1ff; font-weight: bold; }
        #menu-toggle { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; display: none; z-index: 1002; transition: transform 0.3s ease; }
        nav { display: flex; align-items: center; gap: 1.5rem; }
        nav a { color: var(--text-light); text-decoration: none; font-weight: 600; }
        nav a:hover { color: var(--accent-color); }
        .lang-switcher button { background: none; border: 1px solid var(--text-light); color: var(--text-light); width: 35px; height: 35px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease; font-family: inherit; border-radius: 50%; }
        .lang-switcher button.active { background-color: var(--accent-color); font-weight: 700; border-color: var(--accent-color); }

        main { flex-grow: 1; }
        .game-screen { display: none; padding: 2rem 0; animation: fadeIn 0.5s; }
        .game-screen.active { display: block; }
        .game-card { background-color: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); text-align: center; padding: 1.5rem 2rem; }
        .live-player-count { color: var(--secondary-color); font-weight: 600; margin-top: 1.5rem; }
        .game-card h1 { font-size: 2rem; color: var(--primary-color); margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color); }
        .form-group input, .form-group select { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        .btn { display: inline-block; background-color: var(--accent-color); color: var(--text-light); padding: 0.8rem 2rem; border-radius: 25px; text-decoration: none; font-weight: 700; transition: all 0.3s ease; border: none; cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 0.5rem; }
        .btn:hover:not(:disabled) { background-color: #e68a00; transform: translateY(-2px); }
        #question-container { font-size: 2.2rem; margin-bottom: 2rem; min-height: 80px; font-weight: 700; }
        footer { background-color: var(--primary-color); color: var(--text-light); padding: 2rem 0; text-align: center; margin-top: auto; }
        footer a { color: var(--accent-color); text-decoration: none; font-weight: bold; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        #progress-bar-container { width: 100%; background-color: #ddd; border-radius: 5px; margin-bottom: 1rem; } #progress-bar { width: 0%; height: 10px; background-color: var(--accent-color); border-radius: 5px; transition: width 0.3s; } .answer-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
              /* Skeleton Loader */
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }

        @keyframes skeleton-loading {
            0% {
                background-color: hsl(200, 20%, 80%);
            }

            100% {
                background-color: hsl(200, 20%, 95%);
            }
        }

        #skeleton-loader.hidden {
            display: none;
        }

        #skeleton-loader {
            padding: 2rem 0;
        }

        #skeleton-loader .game-card {
            padding: 1.5rem 2rem;
        }

        .skeleton-title {
            width: 100%;
            height: 2.5rem;
            margin: 0 auto 1.5rem auto;
            border-radius: 10px;
        }
 .skeleton-title1 {
            width: 70%;
            height: 0.9rem;
            margin: 0 auto 1.5rem auto;
            border-radius: 8px;
 }
        .skeleton-btn {
            width: 90%;
            height: 3.2rem;
            margin: 2rem auto;
            margin-bottom: 2rem;
            border-radius: 25px;
        }
        
        /* Joining Popup CSS */
        .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--primary-color); color: var(--text-light); padding: 1.5rem 2rem; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 10001; display: none; font-weight: bold; }
        .popup.visible { display: block; }
        
        /* Mobile Menu Responsive Styles */
        @media (max-width: 768px) {
            #menu-toggle { display: block; }
            .nav-wrapper { gap: 0.5rem; }
            nav {
                position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                background: rgba(10, 36, 99, 0.95); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                gap: 2rem; z-index: 1001; transform: translateY(-100%); transition: transform 0.4s ease-in-out;
            }
            nav.active { transform: translateY(0); }
            .lang-switcher { position: absolute; top: 1.5rem; right: 5rem; }
            #question-container { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container"> 
            <a href="#" class="logo" data-key="logo_text"></a>
            <div class="nav-wrapper">
                <div id="ping-display" class="ping-display"></div>
                <nav id="main-nav">
                    <a href="https://odiagames.site/" target="_blank" data-key="main_website_btn"></a>
                    <a href="../.." class="home-link" data-key="home_btn"></a>
                    <a href=".." data-key="other_games_btn"></a>
                    <a href="./about.html" data-key="about_btn"></a>
                    <a href="./results.html" data-key="check_results_btn"></a>
                    <div class="lang-switcher">
                        <button id="lang-or">‡¨ì</button>
                        <button id="lang-en">E</button>
                    </div>
                </nav>
                <button id="menu-toggle">‚ò∞</button>
            </div>
        </div> 
    </header>
    <main>
        <div id="skeleton-loader">
            <div class="container">
                <div class="game-card">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-btn"></div>
                    <div class="skeleton skeleton-btn"></div>
                    <div class="skeleton skeleton-btn"></div>
                </div>
            </div>
        </div>

        <section id="landing-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="welcome"></h1><div class="btn-group" style="display: flex; gap: 1rem; flex-direction: column;"> <button id="show-create-btn" class="btn" data-key="create_room_btn"></button> <button id="show-join-btn" class="btn btn-secondary" data-key="join_room_btn" style="background-color: var(--secondary-color);"></button> <a href="results.html" class="btn btn-secondary" style="background-color: #555;" data-key="check_results_btn_main"></a> </div> <p id="live-player-count" class="live-player-count"></p></div></div> </section>
        <section id="create-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="create_title"></h1> <div class="form-group"> <label for="create-player-name" data-key="name_label"></label> <input type="text" id="create-player-name"> </div> <div class="form-group"> <label for="create-password" data-key="password_label"></label> <input type="text" id="create-password" inputmode="numeric"> </div> <button id="create-btn" class="btn" data-key="create_btn"></button> <div id="create-error" class="error-message" style="color: var(--danger-color); font-weight: bold; margin-top: 1rem; min-height: 1.2em;"></div> <button class="back-btn" data-screen="landing-screen" style="background: none; border: none; color: var(--secondary-color); cursor: pointer; font-size: 0.9rem; margin-top: 1rem;">‚Üê <span data-key="back_btn"></span></button> </div></div> </section>
        <section id="join-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="join_title"></h1> <div class="form-group"> <label for="join-room-code-num" data-key="room_code_label"></label> <div class="room-code-input-group" style="display: flex; align-items: center;"><span class="room-code-prefix" style="background-color: #eee; padding: 0.8rem; border: 1px solid #ccc; border-right: none; border-radius: 8px 0 0 8px; font-weight: bold; color: var(--primary-color);">SB</span><input type="text" id="join-room-code-num" inputmode="numeric" maxlength="4" style="border-radius: 0 8px 8px 0;"></div> </div> <div class="form-group"> <label for="join-player-name" data-key="name_label"></label> <input type="text" id="join-player-name"> </div> <div class="form-group"> <label for="join-password" data-key="password_label"></label> <input type="text" id="join-password" inputmode="numeric"> </div> <button id="join-btn" class="btn" data-key="join_btn"></button> <div id="join-error" class="error-message" style="color: var(--danger-color); font-weight: bold; margin-top: 1rem; min-height: 1.2em;"></div> <button class="back-btn" data-screen="landing-screen" style="background: none; border: none; color: var(--secondary-color); cursor: pointer; font-size: 0.9rem; margin-top: 1rem;">‚Üê <span data-key="back_btn"></span></button> </div></div> </section>
        <section id="lobby-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="lobby_title"></h1> <h2><span data-key="room_code_display"></span> <strong id="lobby-room-code" style="color: var(--accent-color);"></strong></h2> <h3 data-key="players_in_room"></h3> <ul id="player-list" style="list-style: none; margin: 1rem 0; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;"></ul> <div id="host-controls" style="display: none; border-top: 2px solid var(--bg-light); padding-top: 1.5rem; margin-top: 1.5rem;"> <h3 data-key="game_settings_title"></h3> <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"> <div class="form-group"><label for="game-timer" data-key="total_time_label"></label><select id="game-timer"></select></div> <div class="form-group"><label for="question-count" data-key="q_count_label"></label><select id="question-count"></select></div> <div class="form-group"><label for="game-type" data-key="game_type_label"></label><select id="game-type"></select></div> <div class="form-group"><label for="game-difficulty" data-key="difficulty_label"></label><select id="game-difficulty"></select></div> </div> <button id="start-game-btn" class="btn" data-key="start_game_btn" disabled></button> <small id="start-game-info" data-key="start_game_info"></small> </div> <div id="guest-info" style="display: none; border-top: 2px solid var(--bg-light); padding-top: 1.5rem; margin-top: 1.5rem;"> <h3 data-key="game_settings_title"></h3> <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"> <div class="setting-display" style="background-color: var(--bg-light); padding: 0.5rem 1rem; border-radius: 8px; text-align: left;"><strong><span data-key="total_time_label"></span>:</strong> <span id="guest-game-timer"></span></div> <div class="setting-display" style="background-color: var(--bg-light); padding: 0.5rem 1rem; border-radius: 8px; text-align: left;"><strong><span data-key="q_count_label"></span>:</strong> <span id="guest-question-count"></span></div> <div class="setting-display" style="background-color: var(--bg-light); padding: 0.5rem 1rem; border-radius: 8px; text-align: left;"><strong><span data-key="game_type_label"></span>:</strong> <span id="guest-game-type"></span></div> <div class="setting-display" style="background-color: var(--bg-light); padding: 0.5rem 1rem; border-radius: 8px; text-align: left;"><strong><span data-key="difficulty_label"></span>:</strong> <span id="guest-game-difficulty"></span></div> </div> <br> <p data-key="waiting_msg"></p> </div> 
        <div id="share-controls" style="border-top: 2px solid var(--bg-light); padding-top: 1.5rem; margin-top: 1.5rem;"><button id="share-btn" class="btn btn-secondary" data-key="share_btn" style="background-color: var(--secondary-color);"></button></div>
        <button class="back-btn" id="leave-lobby-btn" style="background: none; border: none; color: var(--secondary-color); cursor: pointer; font-size: 0.9rem; margin-top: 1rem;">‚Üê <span data-key="leave_lobby_btn"></span></button> </div></div> </section>
        <section id="game-screen" class="game-screen"> <div class="container"><div class="game-card"> <div class="game-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-weight: bold;"> <span id="question-counter"></span> <span id="main-timer" style="font-size: 1.2rem; color: var(--danger-color);"></span> </div> <div id="progress-bar-container"><div id="progress-bar"></div></div> <div id="question-container"></div> <div id="answer-options" class="answer-options"></div> </div></div> </section>
        <section id="results-screen" class="game-screen"> <div class="container"><div class="game-card"> <h1 data-key="results_title"></h1><h3 id="results-room-code" style="font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 1.5rem;"></h3><h2 id="results-subtitle" data-key="final_scores"></h2><table id="results-table" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><thead ><tr><th data-key="rank_header" style="padding: 0.8rem; border: 1px solid #ddd; text-align: left; background-color: var(--secondary-color); color: var(--text-light);"></th><th data-key="name_header" style="padding: 0.8rem; border: 1px solid #ddd; text-align: left; background-color: var(--secondary-color); color: var(--text-light);"></th><th data-key="score_header" style="padding: 0.8rem; border: 1px solid #ddd; text-align: left; background-color: var(--secondary-color); color: var(--text-light);"></th></tr></thead><tbody id="results-body"></tbody></table> <div id="answer-key-container" style="display: none; text-align: left; max-height: 400px; overflow-y: auto;"></div> <button id="answer-key-btn" class="btn btn-secondary" data-key="show_answers_btn" style="margin-bottom: 1rem; background-color: var(--secondary-color);"></button> <button id="download-report-btn" class="btn" data-key="download_report_btn" style="margin-bottom: 1.5rem; background-color: var(--success-color);"></button> <button id="play-again-btn" class="btn" data-key="play_again_btn"></button></div></div> </section>
        
        <div id="joining-popup" class="popup"></div>
    </main>
    <footer> 
        <div class="container">
            <div data-key="footer_made_by"></div>
        </div> 
    </footer>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
    const firebaseConfig = {
      apiKey: "AIzaSyAYurYfkcGSbRmLNBtXmX60iml5ty8-ipI",
      authDomain: "sbg-math-game.firebaseapp.com",
      databaseURL: "https://sbg-math-game-default-rtdb.firebaseio.com",
      projectId: "sbg-math-game",
      storageBucket: "sbg-math-game.firebasestorage.app",
      messagingSenderId: "520015027553",
      appId: "1:520015027553:web:17c396b24da3fa6e8f3920",
      measurementId: "G-S9KFTEQZ9P"
    };
    firebase.initializeApp(firebaseConfig);
    
    // --- App State and DOM Elements ---
    let appInitialized = false;
    let db;
    const translations = {
        or: {
            logo_text: "‡¨ó‡¨£‡¨ø‡¨§ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û ", main_website_btn: "‡¨Æ‡≠Å‡¨ñ‡≠ç‡≠ü ‡≠±‡≠á‡¨¨‡¨∏‡¨æ‡¨á‡¨ü‡≠ç", home_btn: "‡¨π‡≠ã‡¨Æ‡≠ç", other_games_btn: "‡¨ó‡¨£‡¨ø‡¨§ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û", welcome: "‡¨ó‡¨£‡¨ø‡¨§ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û ‡¨¶‡¨≥ ‡¨ï‡≠Å ‡¨∏‡≠ç‡¨µ‡¨æ‡¨ó‡¨§!", create_room_btn: "‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨§‡¨ø‡¨Ü‡¨∞‡¨ø ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å", join_room_btn: "‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨∞‡≠á ‡¨Ø‡≠ã‡¨ó ‡¨¶‡¨ø‡¨Ö‡¨®‡≠ç‡¨§‡≠Å", check_results_btn: "‡¨´‡¨≥‡¨æ‡¨´‡¨≥", check_results_btn_main: "‡¨™‡≠Å‡¨∞‡≠Å‡¨£‡¨æ ‡¨´‡¨≥‡¨æ‡¨´‡¨≥ ‡¨¶‡≠á‡¨ñ‡¨®‡≠ç‡¨§‡≠Å", create_title: "‡¨è‡¨ï ‡¨ó‡≠á‡¨Æ‡≠ç ‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨§‡¨ø‡¨Ü‡¨∞‡¨ø ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å", room_code_label: "‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨ï‡≠ã‡¨°‡≠ç", name_label: "‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï ‡¨®‡¨æ‡¨Æ", password_label: "‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨™‡¨æ‡¨∏‡≠±‡¨æ‡¨∞‡≠ç‡¨° (‡¨¨‡≠à‡¨ï‡¨≥‡≠ç‡¨™‡¨ø‡¨ï)", create_btn: "‡¨§‡¨ø‡¨Ü‡¨∞‡¨ø ‡¨ï‡¨∞‡¨ø ‡¨≤‡¨¨‡¨ø‡¨∞‡≠á ‡¨™‡≠ç‡¨∞‡¨¨‡≠á‡¨∂ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å", back_btn: "‡¨™‡¨õ‡¨ï‡≠Å", join_title: "‡¨è‡¨ï ‡¨ó‡≠á‡¨Æ‡≠ç ‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨∞‡≠á ‡¨Ø‡≠ã‡¨ó ‡¨¶‡¨ø‡¨Ö‡¨®‡≠ç‡¨§‡≠Å", join_btn: "‡¨≤‡¨¨‡¨ø‡¨∞‡≠á ‡¨Ø‡≠ã‡¨ó ‡¨¶‡¨ø‡¨Ö‡¨®‡≠ç‡¨§‡≠Å", lobby_title: "‡¨≤‡¨¨‡¨ø", room_code_display: "‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨ï‡≠ã‡¨°‡≠ç:", players_in_room: "‡¨ñ‡≠á‡¨≥‡¨æ‡¨≥‡¨ø:", game_settings_title: "‡¨ó‡≠á‡¨Æ‡≠ç ‡¨∏‡≠á‡¨ü‡¨ø‡¨Ç‡¨∏‡≠ç", total_time_label: "‡¨Æ‡≠ã‡¨ü ‡¨∏‡¨Æ‡≠ü", q_count_label: "‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨∏‡¨Ç‡¨ñ‡≠ç‡≠ü‡¨æ", game_type_label: "‡¨ó‡≠á‡¨Æ‡≠ç ‡¨™‡≠ç‡¨∞‡¨ï‡¨æ‡¨∞", difficulty_label: "‡¨ï‡¨†‡¨ø‡¨®‡¨§‡¨æ", type_mix: "‡¨Æ‡¨ø‡¨∂‡≠ç‡¨∞‡¨£", type_add: "‡¨Æ‡¨ø‡¨∂‡¨æ‡¨£", type_sub: "‡¨´‡≠á‡¨°‡¨æ‡¨£", type_mul: "‡¨ó‡≠Å‡¨£‡¨®", type_div: "‡¨π‡¨∞‡¨£", diff_easy: "‡¨∏‡¨π‡¨ú", diff_medium: "‡¨Æ‡¨ß‡≠ç‡≠ü‡¨Æ", diff_hard: "‡¨ï‡¨†‡¨ø‡¨®", diff_extra_hard: "‡¨Ö‡¨§‡¨ø ‡¨ï‡¨†‡¨ø‡¨®", start_game_btn: "‡¨ó‡≠á‡¨Æ‡≠ç ‡¨Ü‡¨∞‡¨Æ‡≠ç‡¨≠ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å", start_game_info: "‡¨Ü‡¨∞‡¨Æ‡≠ç‡¨≠ ‡¨™‡¨æ‡¨á‡¨Å ‡¨∏‡¨∞‡≠ç‡¨¨‡¨®‡¨ø‡¨Æ‡≠ç‡¨® ‡≠® ‡¨ñ‡≠á‡¨≥‡¨æ‡¨≥‡¨ø ‡¨Ü‡¨¨‡¨∂‡≠ç‡≠ü‡¨ï", waiting_msg: "‡¨π‡≠ã‡¨∑‡≠ç‡¨ü‡≠ç ‡¨ó‡≠á‡¨Æ‡≠ç ‡¨Ü‡¨∞‡¨Æ‡≠ç‡¨≠ ‡¨ï‡¨∞‡¨ø‡¨¨‡¨æ‡¨ï‡≠Å ‡¨Ö‡¨™‡≠á‡¨ï‡≠ç‡¨∑‡¨æ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å...", leave_lobby_btn: "‡¨≤‡¨¨‡¨ø ‡¨õ‡¨æ‡¨°‡¨®‡≠ç‡¨§‡≠Å", question: "‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨®", results_title: "‡¨ó‡≠á‡¨Æ‡≠ç ‡¨∏‡¨Æ‡¨æ‡¨™‡≠ç‡¨§!", final_scores: "‡¨Ö‡¨®‡≠ç‡¨§‡¨ø‡¨Æ ‡¨∏‡≠ç‡¨ï‡≠ã‡¨∞‡≠ç", waiting_for_others: "‡¨Ö‡¨®‡≠ç‡≠ü ‡¨ñ‡≠á‡¨≥‡¨æ‡¨≥‡¨ø‡¨ô‡≠ç‡¨ï ‡¨™‡¨æ‡¨á‡¨Å ‡¨Ö‡¨™‡≠á‡¨ï‡≠ç‡¨∑‡¨æ ‡¨ï‡¨∞‡≠Å‡¨õ‡¨ø...", show_answers_btn: "‡¨â‡¨§‡≠ç‡¨§‡¨∞ ‡¨¶‡≠á‡¨ñ‡¨®‡≠ç‡¨§‡≠Å", answer_key: "‡¨â‡¨§‡≠ç‡¨§‡¨∞ ‡¨∏‡≠Ç‡¨ö‡≠Ä", correct_answer: "‡¨∏‡¨†‡¨ø‡¨ï‡≠ç ‡¨â‡¨§‡≠ç‡¨§‡¨∞", your_answer: "‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï ‡¨â‡¨§‡≠ç‡¨§‡¨∞", correct: "‡¨∏‡¨†‡¨ø‡¨ï‡≠ç", incorrect: "‡¨≠‡≠Å‡¨≤", unanswered: "‡¨â‡¨§‡≠ç‡¨§‡¨∞ ‡¨¶‡¨ø‡¨Ü‡¨Ø‡¨æ‡¨á‡¨®‡¨æ‡¨π‡¨ø‡¨Å", rank_header: "‡¨∞‡¨æ‡¨ô‡≠ç‡¨ï‡≠ç", name_header: "‡¨®‡¨æ‡¨Æ", score_header: "‡¨∏‡≠ç‡¨ï‡≠ã‡¨∞‡≠ç", play_again_btn: "‡¨™‡≠Å‡¨£‡¨ø ‡¨ñ‡≠á‡¨≥‡¨®‡≠ç‡¨§‡≠Å", time_up_msg: "‡¨∏‡¨Æ‡≠ü ‡¨∏‡¨Æ‡¨æ‡¨™‡≠ç‡¨§!", room_deleted_msg: "‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨π‡≠ã‡¨∑‡≠ç‡¨ü‡≠ç ‡¨¶‡≠ç‡¨µ‡¨æ‡¨∞‡¨æ ‡¨°‡¨ø‡¨≤‡¨ø‡¨ü‡≠ç ‡¨π‡≠ã‡¨á‡¨Ø‡¨æ‡¨á‡¨õ‡¨ø |", you_msg: "‡¨Ü‡¨™‡¨£", minute_msg: "‡¨Æ‡¨ø‡¨®‡¨ø‡¨ü‡≠ç", download_report_btn: "‡¨∞‡¨ø‡¨™‡≠ã‡¨∞‡≠ç‡¨ü ‡¨°‡¨æ‡¨â‡¨®‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å", room_code_error: "‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø ‡¨è‡¨ï ‡≠™-‡¨Ö‡¨ô‡≠ç‡¨ï ‡¨¨‡¨ø‡¨∂‡¨ø‡¨∑‡≠ç‡¨ü ‡¨ï‡≠ã‡¨°‡≠ç ‡¨¶‡¨ø‡¨Ö‡¨®‡≠ç‡¨§‡≠Å |", general_error: "‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï ‡¨®‡¨æ‡¨Æ ‡¨Ü‡¨¨‡¨∂‡≠ç‡≠ü‡¨ï |", room_exists_error: "This room code already exists.", room_not_found_error: "‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨Æ‡¨ø‡¨≥‡¨ø‡¨≤‡¨æ ‡¨®‡¨æ‡¨π‡¨ø‡¨Å |", room_full_error: "‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨™‡≠Ç‡¨∞‡≠ç‡¨£‡≠ç‡¨£ ‡¨Ö‡¨õ‡¨ø |", name_in_use_error: "‡¨è‡¨π‡¨ø ‡¨®‡¨æ‡¨Æ ‡¨™‡≠Ç‡¨∞‡≠ç‡¨¨‡¨∞‡≠Å ‡¨¨‡≠ç‡≠ü‡¨¨‡¨π‡≠É‡¨§ ‡¨π‡≠ã‡¨á‡¨õ‡¨ø |", password_error: "‡¨≠‡≠Å‡¨≤‡≠ç ‡¨™‡¨æ‡¨∏‡≠±‡¨æ‡¨∞‡≠ç‡¨° |", share_btn: "‡¨∏‡¨æ‡¨ô‡≠ç‡¨ó‡¨Æ‡¨æ‡¨®‡¨ô‡≠ç‡¨ï‡≠Å ‡¨®‡¨ø‡¨Æ‡¨®‡≠ç‡¨§‡≠ç‡¨∞‡¨£ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å", invite_copied: "‡¨®‡¨ø‡¨Æ‡¨®‡≠ç‡¨§‡≠ç‡¨∞‡¨£ ‡¨≤‡¨ø‡¨ô‡≠ç‡¨ï‡≠ç ‡¨ï‡¨™‡¨ø ‡¨π‡≠ã‡¨á‡¨ó‡¨≤‡¨æ!", you_were_kicked_msg: "‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï‡≠Å ‡¨π‡≠ã‡¨∑‡≠ç‡¨ü‡≠ç ‡¨¶‡≠ç‡¨µ‡¨æ‡¨∞‡¨æ ‡¨∞‡≠Å‡¨Æ‡≠ç ‡¨∞‡≠Å ‡¨¨‡¨æ‡¨π‡¨æ‡¨∞ ‡¨ï‡¨∞‡¨ø‡¨¶‡¨ø‡¨Ü‡¨Ø‡¨æ‡¨á‡¨õ‡¨ø |", live_players_text: "‡¨è‡¨¨‡≠á {{count}} ‡¨ú‡¨£ ‡¨ñ‡≠á‡¨≥‡≠Å‡¨õ‡¨®‡≠ç‡¨§‡¨ø", ping_text: "‡¨™‡¨ø‡¨ô‡≠ç‡¨ó‡≠ç", about_btn: "‡¨Ü‡¨Æ ‡¨¨‡¨ø‡¨∑‡≠ü‡¨∞‡≠á", footer_made_by: "‚ù§Ô∏è ‡¨∏‡¨π‡¨ø‡¨§ <a href='https://www.instagram.com/sandeepbiswalg' target='_blank' rel='noopener noreferrer'>‡¨∏‡¨®‡≠ç‡¨¶‡≠Ä‡¨™‡≠ç ‡¨¨‡¨ø‡¨∂‡≠ç‡¨µ‡¨æ‡¨≥ G</a> ‡¨ô‡≠ç‡¨ï ‡¨¶‡≠ç‡¨µ‡¨æ‡¨∞‡¨æ ‡¨™‡≠ç‡¨∞‡¨∏‡≠ç‡¨§‡≠Å‡¨§", ping_offline: "‡¨™‡¨ø‡¨ô‡≠ç‡¨ó‡≠ç: 999ms", no_internet_title: "‡¨ï‡≠å‡¨£‡¨∏‡¨ø ‡¨á‡¨£‡≠ç‡¨ü‡¨∞‡¨®‡≠á‡¨ü‡≠ç ‡¨∏‡¨Ç‡¨Ø‡≠ã‡¨ó ‡¨®‡¨æ‡¨π‡¨ø‡¨Å", no_internet_msg: "‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø ‡¨Æ‡≠ã‡¨¨‡¨æ‡¨á‡¨≤‡≠ç ‡¨°‡¨æ‡¨ü‡¨æ ‡¨ö‡¨æ‡¨≤‡≠Å ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡¨ï‡¨ø‡¨Æ‡≠ç‡¨¨‡¨æ ‡≠±‡¨æ‡¨á‡¨´‡¨æ‡¨á ‡¨∏‡¨π‡¨ø‡¨§ ‡¨∏‡¨Ç‡¨Ø‡≠ã‡¨ó ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å |", joining_room: "SB{{roomCode}} ‡¨∞‡≠á ‡¨Ø‡≠ã‡¨ó ‡¨¶‡≠á‡¨â‡¨õ‡¨ø...",
            detailed_report_header: "‡¨¨‡¨ø‡¨∏‡≠ç‡¨§‡≠É‡¨§ ‡¨â‡¨§‡≠ç‡¨§‡¨∞ ‡¨¨‡¨ø‡¨∂‡≠ç‡¨≥‡≠á‡¨∑‡¨£", answered_header: "‡¨â‡¨§‡≠ç‡¨§‡¨∞ ‡¨¶‡≠á‡¨≤‡≠á", status_header: "‡¨∏‡≠ç‡¨•‡¨ø‡¨§‡¨ø"
        },
        en: {
            logo_text: "Math Wiz", home_btn: "Home", main_website_btn: "Main Website", other_games_btn: "Math Wizard", welcome: "Welcome to Math Wiz!", create_room_btn: "Create Room", join_room_btn: "Join Room", check_results_btn: "Results", check_results_btn_main: "Check Past Results", create_title: "Create a Game Room", room_code_label: "Room Code", name_label: "Your Name", password_label: "Room Password (Optional)", create_btn: "Create & Enter Lobby", back_btn: "Back", join_title: "Join a Game Room", join_btn: "Join Lobby", lobby_title: "Lobby", room_code_display: "Room Code:", players_in_room: "Players:", game_settings_title: "Game Settings", total_time_label: "Total Time", q_count_label: "No. of Questions", game_type_label: "Game Type", difficulty_label: "Difficulty", type_mix: "Mix", type_add: "Addition", type_sub: "Subtraction", type_mul: "Multiplication", type_div: "Division", diff_easy: "Easy", diff_medium: "Medium", diff_hard: "Hard", diff_extra_hard: "Extra Hard", start_game_btn: "Start Game", start_game_info: "Minimum 2 players to start", waiting_msg: "Waiting for the host to start...", leave_lobby_btn: "Leave Lobby", question: "Question", results_title: "Game Over!", final_scores: "Final Scores", waiting_for_others: "Waiting for other players to finish...", show_answers_btn: "Show Answers", answer_key: "Answer Key", correct_answer: "Correct Answer", your_answer: "Your Answer", correct: "Correct", incorrect: "Incorrect", unanswered: "Unanswered", rank_header: "Rank", name_header: "Name", score_header: "Score", play_again_btn: "Play Again", time_up_msg: "Time's Up!", room_deleted_msg: "Room was deleted by host.", you_msg: "You", minute_msg: "Minutes", download_report_btn: "Download Report", room_code_error: "Please enter a 4-digit room code.", general_error: "Your name is required.", room_exists_error: "This room code already exists.", room_not_found_error: "Room not found.", room_full_error: "Room is full.", name_in_use_error: "This name is already in use.", password_error: "Incorrect password.", share_btn: "Invite Friends", invite_copied: "Invite link copied!", you_were_kicked_msg: "You have been removed from the room by the host.", live_players_text: "Now playing: {{count}} people", ping_text: "Ping", about_btn: "About", footer_made_by: "Made with ‚ù§Ô∏è by <a href='https://www.instagram.com/sandeepbiswalg' target='_blank' rel='noopener noreferrer'>Sandeep Biswal G</a>", ping_offline: "Ping: 666+", no_internet_title: "No Internet Connection", no_internet_msg: "Please turn on mobile data or connect to a wifi.", joining_room: "Joining SB{{roomCode}}...",
            detailed_report_header: "Detailed Answer Breakdown", answered_header: "Answered", status_header: "Status"
        }
    };
    const PLAYER_LIMIT = 100;
    let gameState = { roomCode: null, playerName: null, isHost: false, lobbyListener: null, resultsListener: null, questions: [], mainGameTimer: null, pingInterval: null, pingAnimationInterval: null, lastPing: 50 };
    let gameLogicState = { currentQuestionIndex: -1, score: 0, playerAnswers: [] };
    const dom = {}; 
    ['lang-or', 'lang-en', 'show-create-btn', 'show-join-btn', 'create-player-name', 'create-password', 'create-btn', 'create-error', 'join-room-code-num', 'join-player-name', 'join-password', 'join-btn', 'join-error', 'lobby-room-code', 'player-list', 'host-controls', 'guest-info', 'start-game-btn', 'start-game-info', 'leave-lobby-btn', 'game-timer', 'question-count', 'game-type', 'game-difficulty', 'guest-game-timer', 'guest-question-count', 'guest-game-type', 'guest-game-difficulty', 'play-again-btn', 'progress-bar', 'question-counter', 'question-container', 'answer-options', 'main-timer', 'results-body', 'results-subtitle', 'answer-key-btn', 'answer-key-container', 'download-report-btn', 'results-room-code', 'share-btn', 'live-player-count', 'ping-display', 'menu-toggle', 'main-nav', 'joining-popup', 'skeleton-loader'].forEach(id => dom[id.replace(/-/g, '_')] = document.getElementById(id));
    dom.screens = document.querySelectorAll('.game-screen');

    // --- Core Functions ---
    const toOdiaNumerals = s => String(s).replace(/[0-9]/g, d => '‡≠¶‡≠ß‡≠®‡≠©‡≠™‡≠´‡≠¨‡≠≠‡≠Æ‡≠Ø'[d]);
    const displayNum = n => document.documentElement.lang === 'or' ? toOdiaNumerals(n) : String(n);
    const getRoomRef = (rc) => db.ref('rooms/' + rc);
    const getRoomData = async (rc) => { const snapshot = await getRoomRef(rc).get(); return snapshot.exists() ? snapshot.val() : null; };
    const updateRoomData = (rc, updates) => getRoomRef(rc).update(updates);
    const deleteRoom = (rc) => getRoomRef(rc).remove();
    const seededRandom = seed => { let s = seed.split('').reduce((a, b) => (a = (a << 5) - a + b.charCodeAt(0), a & a), 0); return () => (s = Math.imul(s ^ s >>> 15, s | 1), s ^= s + Math.imul(s ^ s >>> 7, s | 61), ((s ^ s >>> 14) >>> 0) / 4294967296); };
    
    // --- Screen and URL Management ---
    const showScreen = (screenId, updateUrl = true) => { dom.screens.forEach(s => s.classList.remove('active')); const screenEl = document.getElementById(screenId); if (screenEl) screenEl.classList.add('active'); if (updateUrl) updateURL(screenId); };
    const updateURL = (screen) => { let hash = ''; switch(screen) { case 'create-screen': hash = 'croom'; break; case 'join-screen': hash = 'jroom'; break; case 'lobby-screen': hash = `lobby/${gameState.roomCode}`; break; case 'game-screen': hash = `game/${gameState.roomCode}`; break; case 'results-screen': hash = `results/${gameState.roomCode}`; break; default: hash = ''; break; } const currentHash = window.location.hash.replace('#', ''); if (hash !== currentHash) { history.pushState({ screen: hash }, '', `#${hash}`); } };
    
    // --- Language Management ---
    function setLanguage(lang) { document.documentElement.lang = lang; document.body.className = `${lang}-lang`; document.querySelectorAll('[data-key]').forEach(el => { const t = translations[lang]?.[el.dataset.key]; if (t) el.innerHTML = t.replace('{{count}}', dom.live_player_count.dataset.count || '0'); }); dom.lang_or.classList.toggle('active', lang === 'or'); dom.lang_en.classList.toggle('active', lang === 'en'); localStorage.setItem('preferredLang', lang); const url = new URL(window.location); url.searchParams.set('lang', lang); history.replaceState({}, '', url); populateSelects(lang); }
    function populateSelects(lang) { const timeOptions = {60:1, 120:2, 300:5, 600:10, 900:15, 1200:20, 1800:30}; dom.game_timer.innerHTML = Object.entries(timeOptions).map(([sec, min]) => `<option value="${sec}">${displayNum(min)} ${translations[lang].minute_msg}</option>`).join(''); const qCountOptions = [10, 15, 20, 30, 50, 60, 80, 100]; dom.question_count.innerHTML = qCountOptions.map(c => `<option value="${c}">${displayNum(c)}</option>`).join(''); const typeKeys = ['mix', 'add', 'sub', 'mul', 'div']; dom.game_type.innerHTML = typeKeys.map(k => `<option value="${k}">${translations[lang]['type_'+k]}</option>`).join(''); const diffKeys = ['easy', 'medium', 'hard', 'extra_hard']; dom.game_difficulty.innerHTML = diffKeys.map(k => `<option value="${k}">${translations[lang]['diff_'+k]}</option>`).join(''); }
    
    function generateMathQuestions(seed, type, difficulty, count) { const r = seededRandom(seed); if (difficulty === 'extra_hard') { return Array.from({ length: count }, () => { let n1, n2, n3, q, a; const template = Math.floor(r() * 4); switch (template) { case 0: n1 = Math.floor(r() * 200) + 100; n2 = Math.floor(r() * 20) + 10; n3 = Math.floor(r() * 20) + 10; q = `${n1} + (${n2} √ó ${n3})`; a = n1 + (n2 * n3); break; case 1: n2 = Math.floor(r() * 100) + 50; n3 = Math.floor(r() * 100) + 50; n1 = (n2 + n3) + Math.floor(r() * 200) + 100; q = `${n1} - (${n2} + ${n3})`; a = n1 - (n2 + n3); break; case 2: n1 = Math.floor(r() * 25) + 15; n2 = Math.floor(r() * 25) + 15; n3 = Math.floor(r() * 100) + 50; q = `(${n1} √ó ${n2}) - ${n3}`; a = (n1 * n2) - n3; break; case 3: const quotient = Math.floor(r() * 25) + 5; n3 = Math.floor(r() * 10) + 2; n2 = n3 * quotient; n1 = quotient + Math.floor(r() * 300) + 100; q = `${n1} - (${n2} √∑ ${n3})`; a = n1 - quotient; break; } const opts = new Set([a]); opts.add(a + (r() > 0.5 ? 10 : -10)); opts.add(a + (r() > 0.5 ? 1 : -1)); while (opts.size < 4) { const wrongAns = a + Math.floor((r() - 0.5) * 50) + 1; if (wrongAns > 0 && wrongAns !== a) opts.add(wrongAns); } return { question: q, options: Array.from(opts).sort(() => r() - 0.5), answer: a }; }); } const ops = type === 'mix' ? ['+', '-', '*', '/'] : {add:['+'], sub:['-'], mul:['*'], div:['/']}[type]; const ranges = { easy: [10, 50, 10, 10], medium: [50, 100, 25, 15], hard: [500, 1000, 50, 30] }; const [addMax, subMax, mulMax, divMax] = ranges[difficulty]; return Array.from({ length: count }, () => { let n1, n2, q, a, op = ops[Math.floor(r() * ops.length)]; switch (op) { case '+': n1 = Math.floor(r() * addMax) + 1; n2 = Math.floor(r() * addMax) + 1; q = `${n1} + ${n2}`; a = n1 + n2; break; case '-': n1 = Math.floor(r() * subMax) + addMax; n2 = Math.floor(r() * (n1 - 1)) + 1; q = `${n1} - ${n2}`; a = n1 - n2; break; case '*': n1 = Math.floor(r() * mulMax) + 2; n2 = Math.floor(r() * mulMax) + 2; q = `${n1} √ó ${n2}`; a = n1 * n2; break; case '/': const d = Math.floor(r() * divMax) + 2, rs = Math.floor(r() * divMax) + 2; n1 = d * rs; n2 = d; q = `${n1} √∑ ${n2}`; a = rs; break; } const opts = new Set([a]); while (opts.size < 4) { const w = a + (Math.floor(r() * 20) + 1) * (r() > 0.5 ? 1 : -1); if (w !== a && w >= 0) opts.add(w); } return { question: q, options: Array.from(opts).sort(() => r() - 0.5), answer: a }; }); }
    
    // --- Game Flow and State Management ---
    function enterLobby(roomCode, playerName, isHost) { sessionStorage.setItem('sbg_roomCode', roomCode); sessionStorage.setItem('sbg_playerName', playerName); gameState = { ...gameState, roomCode, playerName, isHost }; const playerRef = db.ref(`rooms/${roomCode}/players/${playerName}`); playerRef.onDisconnect().remove(); if (isHost) { getRoomRef(roomCode).onDisconnect().remove(); updateDifficultyOptions(); } dom.host_controls.style.display = isHost ? 'block' : 'none'; dom.guest_info.style.display = isHost ? 'none' : 'block'; dom.lobby_room_code.textContent = roomCode; showScreen('lobby-screen'); startLobbyListener(); }
    function startLobbyListener() { if (gameState.lobbyListener) getRoomRef(gameState.roomCode).off('value', gameState.lobbyListener); gameState.lobbyListener = (snapshot) => { const roomData = snapshot.val(); if (!roomData) { leaveLobby(translations[document.documentElement.lang].room_deleted_msg, true); return; } if (!roomData.players || !roomData.players[gameState.playerName]) { leaveLobby(translations[document.documentElement.lang].you_were_kicked_msg, true); return; } const lang = document.documentElement.lang; const players = roomData.players ? Object.values(roomData.players) : []; dom.player_list.innerHTML = players.map(p => `<li><span>${p.name}${p.name === gameState.playerName ? ` (${translations[lang].you_msg})` : ''}${p.isHost ? ' üëë' : ''}</span>${(gameState.isHost && p.name !== gameState.playerName) ? `<button class="remove-player-btn" data-player-name="${p.name}" title="Remove player" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.5rem; font-weight: bold; padding: 0 0.5rem; line-height: 1;">√ó</button>` : ''}</li>`).join(''); if (gameState.isHost) { const canStart = players.length >= 2; dom.start_game_btn.disabled = !canStart; dom.start_game_info.style.display = canStart ? 'none' : 'block'; } else { const { settings } = roomData; dom.guest_game_timer.textContent = `${displayNum(settings.timer / 60)} ${translations[lang].minute_msg}`; dom.guest_question_count.textContent = displayNum(settings.q_count); dom.guest_game_type.textContent = translations[lang][`type_${settings.type}`]; dom.guest_game_difficulty.textContent = translations[lang][`diff_${settings.difficulty}`]; } if (roomData.status === 'started') { getRoomRef(gameState.roomCode).off('value', gameState.lobbyListener); gameState.lobbyListener = null; gameState.questions = roomData.questions; startGame(roomData); } }; getRoomRef(gameState.roomCode).on('value', gameState.lobbyListener); }
    function cleanUpSession() { if (gameState.lobbyListener) getRoomRef(gameState.roomCode).off('value', gameState.lobbyListener); if (gameState.resultsListener) getRoomRef(gameState.roomCode).off('value', gameState.resultsListener); clearInterval(gameState.mainGameTimer); clearInterval(gameState.pingInterval); clearInterval(gameState.pingAnimationInterval); sessionStorage.removeItem('sbg_roomCode'); sessionStorage.removeItem('sbg_playerName'); gameState = { roomCode: null, playerName: null, isHost: false, lobbyListener: null, resultsListener: null, questions: [], mainGameTimer: null, pingInterval: null, pingAnimationInterval: null, lastPing: 50 }; gameLogicState = { currentQuestionIndex: -1, score: 0, playerAnswers: [] }; }
    async function leaveLobby(reason = "", isKicked = false) { const roomCode = gameState.roomCode; const playerName = gameState.playerName; if (roomCode && playerName && !isKicked) { const playerRef = db.ref(`rooms/${roomCode}/players/${playerName}`); await playerRef.onDisconnect().cancel(); await playerRef.remove(); if (gameState.isHost) { const roomData = await getRoomData(roomCode); if(roomData && roomData.status !== 'finished') { await getRoomRef(roomCode).onDisconnect().cancel(); await deleteRoom(roomCode); } } } cleanUpSession(); if (reason) alert(reason); showScreen('landing-screen'); }
    function startGame(roomData) { gameLogicState = { currentQuestionIndex: -1, score: 0, playerAnswers: [] }; showScreen('game-screen'); startMainTimer(roomData); displayNextQuestion(); }
    async function startMainTimer(roomData) { if (gameState.mainGameTimer) clearInterval(gameState.mainGameTimer); const serverTimeOffsetSnapshot = await db.ref('/.info/serverTimeOffset').once('value'); const serverTimeOffset = serverTimeOffsetSnapshot.val() || 0; if (typeof roomData.gameStartedAt !== 'number') { console.error("Game start time not found!"); dom.main_timer.textContent = '...'; return; } const estimatedServerTimeNow = new Date().getTime() + serverTimeOffset; const elapsedTime = Math.floor((estimatedServerTimeNow - roomData.gameStartedAt) / 1000); let timeLeft = roomData.settings.timer - elapsedTime; if (timeLeft < 0) timeLeft = 0; const update = () => dom.main_timer.textContent = `${displayNum(Math.floor(timeLeft/60))}:${displayNum((timeLeft%60).toString().padStart(2,'0'))}`; update(); gameState.mainGameTimer = setInterval(() => { if (--timeLeft < 0) { forceEndGame(true); } else update(); }, 1000); }
    async function displayNextQuestion() { gameLogicState.currentQuestionIndex++; const roomData = await getRoomData(gameState.roomCode); if (!roomData || gameLogicState.currentQuestionIndex >= roomData.settings.q_count) { forceEndGame(false); return; } const q = gameState.questions[gameLogicState.currentQuestionIndex]; dom.progress_bar.style.width = `${((gameLogicState.currentQuestionIndex + 1) / roomData.settings.q_count) * 100}%`; dom.question_counter.textContent = `${translations[document.documentElement.lang].question} ${displayNum(gameLogicState.currentQuestionIndex + 1)}/${displayNum(roomData.settings.q_count)}`; const qText = q.question.split(' ').map(part => isNaN(part) ? part : displayNum(part)).join(' '); dom.question_container.textContent = `${qText} = ?`; dom.answer_options.innerHTML = q.options.map(o => `<button class="btn answer-btn">${displayNum(o)}</button>`).join(''); dom.answer_options.querySelectorAll('.answer-btn').forEach(b => b.onclick = () => handleAnswer(parseInt(b.innerText.replace(/[‡≠¶-‡≠Ø]/g, d => '‡≠¶‡≠ß‡≠®‡≠©‡≠™‡≠´‡≠¨‡≠≠‡≠Æ‡≠Ø'.indexOf(d))))); }
    function handleAnswer(selected) { const q = gameState.questions[gameLogicState.currentQuestionIndex]; if (selected === q.answer) gameLogicState.score++; gameLogicState.playerAnswers.push({ qIndex: gameLogicState.currentQuestionIndex, question: q.question, answer: selected, correctAnswer: q.answer }); dom.answer_options.querySelectorAll('.answer-btn').forEach(btn => { btn.disabled = true; const val = parseInt(btn.innerText.replace(/[‡≠¶-‡≠Ø]/g, d => '‡≠¶‡≠ß‡≠®‡≠©‡≠™‡≠´‡≠¨‡≠≠‡≠Æ‡≠Ø'.indexOf(d))); if (val === q.answer) btn.classList.add('correct'); else if (val === selected) btn.classList.add('incorrect'); }); setTimeout(displayNextQuestion, 400); }
    async function forceEndGame(isTimeUp) { clearInterval(gameState.mainGameTimer); if(isTimeUp) alert(translations[document.documentElement.lang].time_up_msg); showScreen('results-screen'); dom.results_subtitle.setAttribute('data-key', 'waiting_for_others'); setLanguage(document.documentElement.lang); startResultsListener(); const roomData = await getRoomData(gameState.roomCode); if (roomData) { for (let i = gameLogicState.currentQuestionIndex; i < roomData.settings.q_count; i++) { if (gameState.questions && i < gameState.questions.length && !gameLogicState.playerAnswers.find(a => a.qIndex === i)) { gameLogicState.playerAnswers.push({ qIndex: i, question: gameState.questions[i].question, answer: null, correctAnswer: gameState.questions[i].answer }); } } const myResult = { name: gameState.playerName, score: gameLogicState.score, answers: gameLogicState.playerAnswers }; await updateRoomData(gameState.roomCode, { [`results/${gameState.playerName}`]: myResult }); const updatedRoomData = await getRoomData(gameState.roomCode); if(updatedRoomData && updatedRoomData.players && updatedRoomData.results){ const numPlayers = Object.keys(updatedRoomData.players).length; const numResults = Object.keys(updatedRoomData.results).length; if (numResults >= numPlayers) { if (gameState.isHost) { getRoomRef(gameState.roomCode).onDisconnect().cancel(); } await updateRoomData(gameState.roomCode, { status: 'finished' }); } } } }
    function startResultsListener() { if (gameState.resultsListener) getRoomRef(gameState.roomCode).off('value', gameState.resultsListener); gameState.resultsListener = (snapshot) => { const finalRoomData = snapshot.val(); if(finalRoomData && finalRoomData.status === 'finished') { getRoomRef(gameState.roomCode).off('value', gameState.resultsListener); gameState.resultsListener = null; dom.results_room_code.textContent = `Room: ${gameState.roomCode}`; dom.results_subtitle.setAttribute('data-key', 'final_scores'); setLanguage(document.documentElement.lang); const results = Object.values(finalRoomData.results); dom.results_body.innerHTML = results.sort((a,b) => b.score - a.score).map((r, i) => `<tr><td>${displayNum(i+1)}</td><td>${r.name}</td><td>${displayNum(r.score)}/${displayNum(finalRoomData.settings.q_count)}</td></tr>`).join(''); } }; getRoomRef(gameState.roomCode).on('value', gameState.resultsListener); }
    
    // --- Event Listeners & UI Logic ---
    dom.menu_toggle.onclick = () => { const isActive = dom.main_nav.classList.toggle('active'); dom.menu_toggle.textContent = isActive ? '‚úï' : '‚ò∞'; dom.menu_toggle.style.transform = isActive ? 'rotate(180deg)' : 'rotate(0deg)'; };
    dom.show_create_btn.onclick = () => showScreen('create-screen');
    dom.show_join_btn.onclick = () => showScreen('join-screen');
    document.querySelectorAll('.back-btn, .home-link').forEach(btn => btn.onclick = (e) => { e.preventDefault(); leaveLobby(); });
    dom.leave_lobby_btn.onclick = () => leaveLobby();
    async function generateUniqueRoomCode() { let roomCode; let roomExists = true; while(roomExists) { const randomNum = Math.floor(1000 + Math.random() * 9000).toString(); roomCode = `SB${randomNum}`; const data = await getRoomData(roomCode); roomExists = data !== null; } return roomCode; }
    dom.create_btn.onclick = async () => { const pn = dom.create_player_name.value.trim(); const pw = dom.create_password.value.trim(); const lang = document.documentElement.lang; dom.create_error.textContent = ''; if (!pn) { dom.create_error.textContent = translations[lang].general_error; return; } const rc = await generateUniqueRoomCode(); const settings = { timer: 60, q_count: 10, type: 'mix', difficulty: 'easy' }; await getRoomRef(rc).set({ password: pw || null, players: { [pn]: { name: pn, isHost: true } }, status: 'lobby', settings, createdAt: firebase.database.ServerValue.TIMESTAMP }); enterLobby(rc, pn, true); };
    dom.join_btn.onclick = async () => { const rcNum = dom.join_room_code_num.value.trim(); const pn = dom.join_player_name.value.trim(); const pw = dom.join_password.value.trim(); const lang = document.documentElement.lang; dom.join_error.textContent = ''; if (rcNum.length !== 4 || !/^\d{4}$/.test(rcNum)) { dom.join_error.textContent = translations[lang].room_code_error; return; } if (!pn) { dom.join_error.textContent = translations[lang].general_error; return; } const rc = `SB${rcNum}`; dom.joining_popup.textContent = translations[lang].joining_room.replace('{{roomCode}}', rcNum); dom.joining_popup.classList.add('visible'); try { const rd = await getRoomData(rc); if (!rd) { dom.join_error.textContent = translations[lang].room_not_found_error; return; } if (rd.players && Object.keys(rd.players).length >= PLAYER_LIMIT) { dom.join_error.textContent = translations[lang].room_full_error; return; } if (rd.players && rd.players[pn]) { dom.join_error.textContent = translations[lang].name_in_use_error; return; } if (rd.password && rd.password !== pw) { dom.join_error.textContent = translations[lang].password_error; return; } await updateRoomData(rc, { [`players/${pn}`]: { name: pn, isHost: false } }); enterLobby(rc, pn, false); } finally { dom.joining_popup.classList.remove('visible'); } };
    dom.start_game_btn.onclick = async () => { if (!gameState.isHost || !gameState.roomCode) return; dom.start_game_btn.disabled = true; const roomData = await getRoomData(gameState.roomCode); if (!roomData || !roomData.players || Object.keys(roomData.players).length < 2) { dom.start_game_btn.disabled = false; return; } const { settings } = roomData; const questions = generateMathQuestions(gameState.roomCode, settings.type, settings.difficulty, Number(settings.q_count)); await updateRoomData(gameState.roomCode, { status: 'started', questions: questions, gameStartedAt: firebase.database.ServerValue.TIMESTAMP }); };
    
    // ================== START OF FIX ==================
    dom.download_report_btn.onclick = async () => {
        const roomData = await getRoomData(gameState.roomCode);
        if (!roomData || roomData.status !== 'finished' || !roomData.results || !roomData.questions) {
            alert("Report data is not fully available yet. Please wait for the game to finish completely.");
            return;
        }

        const lang = document.documentElement.lang;
        const currentTranslations = translations[lang];
        const results = Object.values(roomData.results).sort((a, b) => b.score - a.score);
        
        let reportContent = `SB Math Wiz - Game Report\n`;
        reportContent += `=========================\n\n`;
        reportContent += `Room Code: ${gameState.roomCode}\n`;
        reportContent += `Date: ${new Date(roomData.createdAt).toLocaleString()}\n\n`;
        
        // --- Part 1: Final Scores Summary ---
        reportContent += `${currentTranslations.final_scores}:\n`;
        reportContent += `------------\n`;
        const headerRank = (currentTranslations.rank_header || 'Rank').padEnd(6);
        const headerName = (currentTranslations.name_header || 'Name').padEnd(21);
        const headerScore = (currentTranslations.score_header || 'Score');
        reportContent += `${headerRank}${headerName}${headerScore}\n`;

        results.forEach((r, i) => {
            const rank = (i + 1).toString().padEnd(6);
            const name = r.name.padEnd(21);
            const score = `${r.score}/${roomData.settings.q_count}`;
            reportContent += `${rank}${name}${score}\n`;
        });

        // --- Part 2: Detailed Question Breakdown ---
        reportContent += `\n\n=========================\n`;
        reportContent += `${currentTranslations.detailed_report_header}:\n`;
        reportContent += `=========================\n\n`;

        roomData.questions.forEach((q, index) => {
            const qNum = index + 1;
            const qText = q.question.split(' ').map(p => isNaN(p) ? p : displayNum(p)).join(' ');
            reportContent += `${currentTranslations.question} ${qNum}: ${qText} = ${displayNum(q.answer)}\n`;

            results.forEach(playerResult => {
                const playerAnswerObj = playerResult.answers.find(a => a.qIndex === index);
                let answerText;
                let statusText;

                if (playerAnswerObj) {
                    if (playerAnswerObj.answer === null) {
                        answerText = currentTranslations.unanswered;
                        statusText = `(${currentTranslations.incorrect})`;
                    } else {
                        answerText = displayNum(playerAnswerObj.answer);
                        if (playerAnswerObj.answer === q.answer) {
                            statusText = `(${currentTranslations.correct})`;
                        } else {
                            statusText = `(${currentTranslations.incorrect})`;
                        }
                    }
                } else {
                    answerText = "N/A"; // Should not happen, but for safety
                    statusText = "";
                }
                
                reportContent += `  - ${playerResult.name.padEnd(20)}: ${currentTranslations.answered_header} ${answerText.padEnd(8)} ${statusText}\n`;
            });
            reportContent += `\n`; // Add a space between questions
        });

        reportContent += `\nReport generated by SB Odia Games.`;

        // Create a blob and trigger download
        const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Game-Report-${gameState.roomCode}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    };
    // =================== END OF FIX ===================

    function updateDifficultyOptions() { const gameType = dom.game_type.value; const extraHardOption = dom.game_difficulty.querySelector('option[value="extra_hard"]'); if (extraHardOption) { extraHardOption.disabled = (gameType !== 'mix'); if (gameType !== 'mix' && dom.game_difficulty.value === 'extra_hard') { dom.game_difficulty.value = 'hard'; if(gameState.isHost) { updateRoomData(gameState.roomCode, { 'settings/difficulty': 'hard' }); } } } }
    dom.game_type.onchange = () => { updateDifficultyOptions(); if(gameState.isHost) { updateRoomData(gameState.roomCode, { 'settings/type': dom.game_type.value }); } };
    ['game-timer', 'question-count', 'game-difficulty'].forEach(elId => { dom[elId.replace('-', '_')].onchange = (e) => { if (gameState.isHost) { let key, val = e.target.value; if(e.target.id === 'game-timer') key = 'timer'; else if(e.target.id === 'question-count') key = 'q_count'; else if(e.target.id === 'game-difficulty') key = 'difficulty'; if(key) updateRoomData(gameState.roomCode, { [`settings/${key}`]: val }); } }; });
    [dom.create_password, dom.join_password, dom.join_room_code_num].forEach(el => el.addEventListener('input', e => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); }));
    dom.play_again_btn.onclick = () => { dom.answer_key_container.style.display = 'none'; cleanUpSession(); showScreen('landing-screen'); };
    dom.answer_key_btn.onclick = async () => { const lang = document.documentElement.lang; const roomData = await getRoomData(gameState.roomCode); if (!roomData || !roomData.results) return; const myResult = roomData.results[gameState.playerName]; if (!myResult) return; const questions = roomData.questions; let keyHTML = `<h3 data-key="answer_key">${translations[lang].answer_key}</h3><table style="font-size: 0.9rem;">`; questions.forEach((q, i) => { const playerAnswerObj = myResult.answers.find(a => a.qIndex === i); let answerText; if (!playerAnswerObj || playerAnswerObj.answer === null) { answerText = `<span style="color:var(--danger-color);">${translations[lang].unanswered}</span>`; } else if (playerAnswerObj.answer === q.answer) { answerText = `<span style="color:var(--success-color);">${translations[lang].correct}</span>`; } else { answerText = `<span style="color:var(--danger-color);">${translations[lang].incorrect}</span> (${translations[lang].your_answer}: ${displayNum(playerAnswerObj.answer)})`; } const qText = q.question.split(' ').map(p => isNaN(p) ? p : displayNum(p)).join(' '); keyHTML += `<tr><td>${displayNum(i+1)}. ${qText} = ${displayNum(q.answer)}</td><td>${answerText}</td></tr>`; }); keyHTML += '</table>'; dom.answer_key_container.innerHTML = keyHTML; dom.answer_key_container.style.display = dom.answer_key_container.style.display === 'block' ? 'none' : 'block'; };
    dom.lang_or.onclick = () => setLanguage('or');
    dom.lang_en.onclick = () => setLanguage('en');
    dom.share_btn.onclick = () => { const url = new URL(window.location); url.hash = `join/${gameState.roomCode.replace('SB','')}`; navigator.clipboard.writeText(url.toString()).then(() => { alert(translations[document.documentElement.lang].invite_copied); }); };
    dom.player_list.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('remove-player-btn')) { const playerNameToRemove = e.target.dataset.playerName; if (playerNameToRemove && gameState.isHost) { if (confirm(`Are you sure you want to remove ${playerNameToRemove}?`)) { db.ref(`rooms/${gameState.roomCode}/players/${playerNameToRemove}`).remove(); } } } });

    // --- Live Count, Ping & Connection State ---
    function startLivePlayerCountListener() { db.ref('rooms').on('value', (snapshot) => { let totalPlayers = 0; if (snapshot.exists()) { snapshot.forEach(roomSnapshot => { const room = roomSnapshot.val(); if (room.status !== 'finished' && room.players) { totalPlayers += Object.keys(room.players).length; } }); } const lang = document.documentElement.lang; dom.live_player_count.dataset.count = totalPlayers; dom.live_player_count.textContent = (translations[lang]?.live_players_text || "").replace('{{count}}', displayNum(totalPlayers)); }); }
    
    function measurePing() { const startTime = Date.now(); db.ref('.info/serverTimeOffset').once('value', (snap, err) => { if(err){ return; } const latency = Date.now() - startTime; gameState.lastPing = latency; const lang = document.documentElement.lang; dom.ping_display.textContent = `${translations[lang].ping_text}: ${latency}ms`; if (latency >= 300) { dom.ping_display.style.color = 'var(--danger-color)'; } else if (latency >= 100) { dom.ping_display.style.color = 'var(--accent-color)'; } else { dom.ping_display.style.color = 'var(--success-color)'; }}); }
    
    function handleConnectionState() { let disconnectTimer; const connectedRef = db.ref('.info/connected'); connectedRef.on('value', (snap) => { const lang = document.documentElement.lang; clearInterval(gameState.pingAnimationInterval); if (snap.val() === false) { disconnectTimer = setTimeout(() => { dom.no_internet_overlay.classList.add('visible'); }, 1000); let currentPing = gameState.lastPing; gameState.pingAnimationInterval = setInterval(() => { currentPing += Math.floor(Math.random() * 20) + 10; if(currentPing >= 666) { dom.ping_display.textContent = translations[lang].ping_offline; clearInterval(gameState.pingAnimationInterval); } else { dom.ping_display.textContent = `${translations[lang].ping_text}: ${currentPing}ms`; } dom.ping_display.style.color = 'var(--danger-color)'; }, 50); } else { clearTimeout(disconnectTimer); dom.no_internet_overlay.classList.remove('visible'); if(appInitialized) measurePing(); } }); }

    // --- Initialization and Routing ---
    async function handleRouting() { if (!appInitialized) return; const hash = window.location.hash.replace('#', ''); const [screen, param] = hash.split('/'); const playerNameFromSession = sessionStorage.getItem('sbg_playerName'); const roomCodeFromSession = sessionStorage.getItem('sbg_roomCode'); if (param && playerNameFromSession && `SB${param}` === roomCodeFromSession) { const roomData = await getRoomData(roomCodeFromSession); if (roomData && roomData.players && roomData.players[playerNameFromSession]) { gameState.roomCode = roomCodeFromSession; gameState.playerName = playerNameFromSession; gameState.isHost = roomData.players[playerNameFromSession].isHost; gameState.questions = roomData.questions || []; if (roomData.status === 'lobby' && screen === 'lobby') { enterLobby(roomCodeFromSession, playerNameFromSession, gameState.isHost); return; } if (roomData.status === 'started' && screen === 'game') { startGame(roomData); return; } if (roomData.status === 'finished' && screen === 'results') { showScreen('results-screen', false); startResultsListener(); return; } } } cleanUpSession(); if (screen === 'croom') { showScreen('create-screen', false); } else if (screen === 'jroom') { showScreen('join-screen', false); } else if (screen === 'join' && param) { dom.join_room_code_num.value = param.replace('SB', ''); showScreen('join-screen', false); } else { dom.skeleton_loader.style.display = 'none'; showScreen('landing-screen', false); } }

    function init() {
        try {
            if (!firebaseConfig || !firebaseConfig.apiKey) { document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red; font-size: 1.2rem;"><h1>Configuration Error</h1><p>Firebase keys are missing.</p></div>`; return; }
            db = firebase.database();
            
            handleConnectionState();
            
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true && !appInitialized) {
                    appInitialized = true;
                    dom.skeleton_loader.classList.add('hidden');
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const langFromUrl = urlParams.get('lang');
                    const langFromStorage = localStorage.getItem('preferredLang');
                    setLanguage(langFromUrl || langFromStorage || 'or');
                    handleRouting();
                    window.addEventListener('popstate', handleRouting);
                    startLivePlayerCountListener();
                    
                    if (navigator.onLine) {
                        measurePing();
                        clearInterval(gameState.pingInterval);
                        gameState.pingInterval = setInterval(measurePing, 5000);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red; font-size: 1.2rem;"><h1>Initialization Error</h1><p>Could not connect to Firebase.</p></div>`;
        }
    }

    init();
});
</script>

</body>
</html>
